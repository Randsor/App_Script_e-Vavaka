<script>
// --- CONFIG & STATE ---
const VIEW_MODE_MASTER = 'MASTER';
const VIEW_MODE_PIVOT = 'PIVOT';
const VIEW_MODE_MOBILE = 'MOBILE';

let CURRENT_VIEW = VIEW_MODE_MASTER;
let PLANNING_DATA = []; 
let ROLES_CONFIG = []; 
let NAMES_DB = [];
let NEXT_CULT_INDEX = -1;
let NEXT_CULT_DATE_STR = "";

// PAGINATION
let PAGINATION = {
    MASTER: { start: 0, visible: 5 },
    PIVOT: { start: 0, visible: 6 }
};

let IS_FULL_LOADED = false;
let HAS_SCROLLED_ONCE = false;

// --- INIT ---
function initPlanningView() {
    movePopupsToBody();
    
    // On force un recalcul du layout au cas où on vient d'un autre module
    setTimeout(() => {
        calculateVisibleColumns('MASTER');
        calculateVisibleColumns('PIVOT');
    }, 50);
    
    // Si données déjà chargées, on rafraîchit juste l'affichage
    if(PLANNING_DATA.length > 0) {
        refreshAllViews();
        return;
    }
    
    PLANNING_DATA = [];
    IS_FULL_LOADED = false;
    HAS_SCROLLED_ONCE = false;
    
    if (window.innerWidth < 768) CURRENT_VIEW = VIEW_MODE_MOBILE;
    
    const skel = document.getElementById('plSkeleton');
    if(skel) skel.classList.remove('hidden');
    
    window.addEventListener('resize', handleResize);
    document.addEventListener('keydown', handleKeyboardNav);

    google.script.run
        .withSuccessHandler(onFastDataLoaded)
        .withFailureHandler(err => {
            alert("Erreur: " + err.message);
            if(skel) skel.classList.add('hidden');
        })
        .getPlanningMatrixData(-30, 90);
}

function onFastDataLoaded(response) {
    processDataChunk(response);
    const skel = document.getElementById('plSkeleton');
    if(skel) skel.classList.add('hidden');
    
    setTimeout(() => {
        if(!IS_FULL_LOADED) {
            google.script.run.withSuccessHandler(onBackgroundDataLoaded).getPlanningMatrixData(-365, 730);
        }
    }, 1500);
}

function onBackgroundDataLoaded(response) {
    processDataChunk(response);
    IS_FULL_LOADED = true;
    if(PLANNING_DATA.length < 100) refreshAllViews();
}

function processDataChunk(response) {
    if (!ROLES_CONFIG.length) ROLES_CONFIG = response.roles || [];
    if (!NAMES_DB.length) NAMES_DB = response.noms || [];
    
    const newEvents = response.events || [];
    const currentKeys = new Set(PLANNING_DATA.map(e => e.date + "-" + e.heure));
    let added = false;
    newEvents.forEach(evt => {
        const key = evt.date + "-" + evt.heure;
        if (!currentKeys.has(key)) { PLANNING_DATA.push(evt); added = true; }
    });
    
    if (added) {
        PLANNING_DATA.sort((a,b) => a.dateObj - b.dateObj);
        
        const now = new Date().setHours(0,0,0,0);
        NEXT_CULT_INDEX = PLANNING_DATA.findIndex(e => e.dateObj >= now);
        
        // NOUVEAU : On stocke la date du prochain pour grouper
        if (NEXT_CULT_INDEX > -1) {
            NEXT_CULT_DATE_STR = PLANNING_DATA[NEXT_CULT_INDEX].date; // ex: "11/01/2026"
        } else {
            NEXT_CULT_DATE_STR = "";
        }
        
        // Recalcul important à chaque charge de données
        calculateVisibleColumns('MASTER');
        calculateVisibleColumns('PIVOT');
        refreshAllViews();
        
        if (!HAS_SCROLLED_ONCE && NEXT_CULT_INDEX > -1) {
            setTimeout(forceScrollToNext, 200);
            HAS_SCROLLED_ONCE = true;
        }
    }
}

// --- VIEW MANAGEMENT ---

function switchPlanningMode(mode) {
    CURRENT_VIEW = mode;
    const switcher = document.getElementById('viewSwitcher');
    if(switcher) switcher.setAttribute('data-active', mode);
    
    const masterEl = document.getElementById('viewContainerMaster');
    const pivotEl = document.getElementById('viewContainerPivot');
    
    // Reset Scroll pour éviter le "saut"
    if (masterEl) { masterEl.scrollLeft = 0; }
    if (pivotEl) { pivotEl.scrollLeft = 0; }
    
    if (mode === 'MASTER') {
        masterEl.classList.remove('pl-view-hidden');
        pivotEl.classList.add('pl-view-hidden');
        calculateVisibleColumns('MASTER');
        if(masterEl.innerHTML === "") renderMasterView(masterEl);
    } else {
        masterEl.classList.add('pl-view-hidden');
        pivotEl.classList.remove('pl-view-hidden');
        calculateVisibleColumns('PIVOT');
        if(pivotEl.innerHTML === "") renderPivotView(pivotEl);
    }
    
    setTimeout(forceScrollToNext, 50);
}

function refreshAllViews() {
    if (CURRENT_VIEW === VIEW_MODE_MOBILE) {
        renderMobileView(document.getElementById('mobileViewport'));
        return;
    }
    renderMasterView(document.getElementById('viewContainerMaster'));
    renderPivotView(document.getElementById('viewContainerPivot'));
}

// --- CALCUL DE DIMENSION ROBUSTE ---
function calculateVisibleColumns(mode) {
    const containerId = (mode === 'MASTER') ? 'viewContainerMaster' : 'viewContainerPivot';
    const container = document.getElementById(containerId);
    
    // Largeur totale disponible (Fallback sur window si caché)
    const containerW = (container && container.clientWidth > 0) 
        ? container.clientWidth 
        : document.querySelector('.pl-wrapper').clientWidth;
    
    const dateColW = 220; // Doit matcher le CSS (--col-date-w)
    const userColW = 160; // Doit matcher le CSS (--col-min-w)
    
    // Marge de sécurité de 40px pour scrollbar et paddings
    const available = containerW - dateColW - 40;
    
    const count = Math.floor(available / userColW);
    PAGINATION[mode].visible = Math.max(1, count);
}

function navColumns(dir) {
    const mode = CURRENT_VIEW;
    if(mode === VIEW_MODE_MOBILE) return;
    
    const state = PAGINATION[mode];
    const totalItems = (mode === 'MASTER') ? ROLES_CONFIG.length : PLANNING_DATA.length;
    const maxStart = Math.max(0, totalItems - state.visible);
    
    state.start += (dir * state.visible);
    if(state.start < 0) state.start = 0;
    if(state.start > maxStart) state.start = maxStart;
    
    if(mode === 'MASTER') renderMasterView(document.getElementById('viewContainerMaster'));
    else renderPivotView(document.getElementById('viewContainerPivot'));
}

// --- RENDERERS ---

function renderMasterView(container) {
    if(!container) return;
    const state = PAGINATION.MASTER;
    const visibleRoles = ROLES_CONFIG.slice(state.start, state.start + state.visible);
    
    const table = document.createElement('table');
    table.className = 'pl-table';
    
    // HEADERS
    let thead = `<thead class="pl-thead"><tr><th class="th-corner">CULTES</th>`;
    visibleRoles.forEach(r => {
        const iconClass = getRoleIconClass(r.name);
        thead += `<th class="th-col" style="text-align:center;"><i class="bi ${iconClass} me-2 opacity-50"></i>${r.name}</th>`;
    });
    thead += `</tr></thead>`;
    table.innerHTML = thead;
    
    // BODY
    const tbody = document.createElement('tbody');
    let lastYear = null;

    PLANNING_DATA.forEach((evt, rowIdx) => {
        const dObj = new Date(evt.dateObj);
        const currentYear = dObj.getFullYear();

        // --- SÉPARATEUR ANNÉE ---
        if (lastYear && currentYear !== lastYear) {
            const trSep = document.createElement('tr');
            trSep.className = 'year-row';
            const totalCols = 1 + visibleRoles.length;
            trSep.innerHTML = `
                <td colspan="${totalCols}">
                    <div class="year-divider">
                        <span class="year-label">${currentYear}</span>
                        <div class="year-line"></div>
                    </div>
                </td>`;
            tbody.appendChild(trSep);
        }
        lastYear = currentYear;

        // --- LIGNE CULTE ---
        const tr = document.createElement('tr');
        tr.className = 'pl-row';
        tr.id = `row-master-${rowIdx}`;
        
        // LOGIQUE HIGHLIGHT PAR GROUPE DE DATE
        const isNextGroup = (evt.date === NEXT_CULT_DATE_STR);
        
        if (isNextGroup) tr.classList.add('is-next');
        if (rowIdx < NEXT_CULT_INDEX && !isNextGroup) tr.classList.add('is-past');
        
        // --- 1. DATE WIDGET (Avec Poubelle) ---
        // On ajoute la classe 'hover-trigger' au TD pour gérer l'apparition
        const dateHtml = `
        <td class="td-date hover-trigger">
            <div class="date-layout" onclick="openSlotMenu(this, '${evt.date}', '${evt.heure}', '${titleSafe}')">
                <div class="d-calendar">
                    <div class="d-weekday">${weekday}</div>
                    <div class="d-day">${day}</div>
                    <div class="d-month">${month}</div>
                </div>
                <div class="d-separator"></div>
                <div class="d-info">
                    <div class="d-title" title="${titleSafe}">${titleSafe}</div>
                    <div class="d-time">${evt.heure}</div>
                </div>
            </div>
            <!-- BOUTON SUPPRESSION (Global CSS btn-action-danger) -->
            <i class="bi bi-trash3 btn-action-danger" 
               onclick="window.TARGET_SLOT={d:'${evt.date}',h:'${evt.heure}'}; confirmDeleteSlot();" 
               title="Supprimer ce culte"></i>
        </td>`;
        
        let rowHtml = dateHtml;
        
        // --- 2. USER CELLS (Avec Actions) ---
        visibleRoles.forEach(role => {
            const val = evt.assignments[role.name] || "";
            const cssClass = val ? "user-cell filled" : "user-cell empty";
            
            // Contenu dynamique
            let innerContent = "";
            if (val) {
                // Rempli : Nom + Crayon
                innerContent = `
                    <span class="text-truncate" style="flex:1;">${val}</span>
                    <div class="hover-actions-group">
                        <div class="btn-circle-action" title="Modifier"><i class="bi bi-pencil-fill" style="font-size:10px;"></i></div>
                    </div>`;
            } else {
                // Vide : Bouton +
                innerContent = `
                    <div class="hover-actions-group" style="width:100%; justify-content:center; opacity:0.6;">
                        <div class="btn-circle-action add"><i class="bi bi-plus-lg"></i></div>
                    </div>`;
            }
            
            // On ajoute 'hover-trigger' pour l'animation
            rowHtml += `
            <td onclick="openNamePopup(this, '${evt.date}', '${evt.heure}', '${role.name}', '${val}')" class="hover-trigger">
                <div class="${cssClass}">
                    ${innerContent}
                </div>
            </td>`;
        });
        
        tr.innerHTML = rowHtml;
        tbody.appendChild(tr);
    });
    
    table.appendChild(tbody);
    container.innerHTML = "";
    container.appendChild(table);
}

function renderPivotView(container) {
    if(!container) return;
    const state = PAGINATION.PIVOT;
    const visibleEvents = PLANNING_DATA.slice(state.start, state.start + state.visible);
    
    const table = document.createElement('table');
    table.className = 'pl-table';
    
    let thead = `<thead class="pl-thead"><tr><th class="th-corner">RÔLE</th>`;
    visibleEvents.forEach((evt, idx) => {
        const realIdx = state.start + idx;
        const idCol = `col-pivot-${realIdx}`;
        const dShort = new Date(evt.dateObj).toLocaleDateString('fr-FR', {day:'numeric', month:'short'});
        const style = (realIdx === NEXT_CULT_INDEX) ? "color:var(--pl-primary); font-weight:800;" : "";
        thead += `<th class="th-col" id="${idCol}"><span style="${style}">${dShort}</span><br><small>${evt.heure}</small></th>`;
    });
    thead += `</tr></thead>`;
    table.innerHTML = thead;
    
    const tbody = document.createElement('tbody');
    ROLES_CONFIG.forEach(role => {
        const tr = document.createElement('tr');
        tr.className = 'pl-row';
        let rowHtml = `<td class="td-date"><div style="padding:0 16px; font-weight:600; color:#64748B; font-size:12px;">${role.name}</div></td>`;
        visibleEvents.forEach(evt => {
            const val = evt.assignments[role.name] || "";
            const cssClass = val ? "user-cell filled" : "user-cell empty";
            rowHtml += `<td onclick="openNamePopup(this, '${evt.date}', '${evt.heure}', '${role.name}', '${val}')"><div class="${cssClass}"><span>${val || ""}</span></div></td>`;
        });
        tr.innerHTML = rowHtml;
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    container.innerHTML = "";
    container.appendChild(table);
}

function renderMobileView(container) {
    const start = Math.max(0, NEXT_CULT_INDEX - 2);
    const end = Math.min(PLANNING_DATA.length, NEXT_CULT_INDEX + 10);
    const subset = PLANNING_DATA.slice(start, end);
    let html = "";
    subset.forEach(evt => {
        const isNext = (PLANNING_DATA.indexOf(evt) === NEXT_CULT_INDEX);
        const dObj = new Date(evt.dateObj);
        const dateStr = dObj.toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long'});
        const borderClass = isNext ? "border-primary" : "";
        html += `
        <div class="card mb-3 shadow-sm border-0 ${borderClass}" style="border-radius:12px;">
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3 border-bottom pb-2">
                    <div class="fw-bold text-capitalize">${dateStr}</div>
                    <div class="badge bg-light text-dark border">${evt.heure}</div>
                </div>
                ${isNext ? '<div class="badge bg-primary mb-3">Prochain</div>' : ''}
                <div class="d-flex flex-column gap-2">`;
        ROLES_CONFIG.forEach(role => {
            const val = evt.assignments[role.name];
            if(val) html += `<div class="d-flex justify-content-between small"><span class="text-muted">${role.name}</span><span class="fw-bold">${val}</span></div>`;
        });
        html += `</div></div></div>`;
    });
    container.innerHTML = html;
}

// --- UTILS & ACTIONS ---
function forceScrollToNext() {
    // Si pas de date prochaine identifiée, on ne fait rien
    // Note: NEXT_CULT_DATE_STR doit être définie en haut du fichier (let NEXT_CULT_DATE_STR = "";)
    if (!NEXT_CULT_DATE_STR && NEXT_CULT_INDEX === -1) return;
    
    // Stratégie : D'abord par date string (nouveau système), sinon fallback sur l'index (ancien système)
    let targetIdx = -1;
    
    if (NEXT_CULT_DATE_STR) {
        targetIdx = PLANNING_DATA.findIndex(e => e.date === NEXT_CULT_DATE_STR);
    } else {
        targetIdx = NEXT_CULT_INDEX;
    }
    
    if (targetIdx > -1) {
        if (CURRENT_VIEW === VIEW_MODE_MASTER) {
            const row = document.getElementById(`row-master-${targetIdx}`);
            // block: 'start' avec behavior 'smooth' pour l'effet visuel
            if(row) row.scrollIntoView({behavior: 'smooth', block: 'start'});
        } else if (CURRENT_VIEW === VIEW_MODE_PIVOT) {
            // En pivot, on change la pagination pour afficher la colonne
            // COL_START_INDEX gère le décalage horizontal des colonnes (dates en pivot)
            // Note: En pivot simplifié actuel, c'est l'inverse (Rôles en ligne), 
            // donc il faudrait scroller vers la colonne, mais comme on a paginé...
            // Pour l'instant on laisse le pivot tel quel ou on implémente la nav colonnes
             COL_START_INDEX = Math.max(0, targetIdx - 1);
             renderCurrentView();
        }
    }
}

function handleResize() { 
    calculateVisibleColumns('MASTER');
    calculateVisibleColumns('PIVOT');
    if(CURRENT_VIEW === VIEW_MODE_MASTER) renderMasterView(document.getElementById('viewContainerMaster'));
    else if(CURRENT_VIEW === VIEW_MODE_PIVOT) renderPivotView(document.getElementById('viewContainerPivot'));
}

function closeAllPopups() {
    document.querySelectorAll('.notion-popup, .notion-dialog, .dropdown-menu').forEach(e => e.style.display='none');
    document.getElementById('popupOverlay').style.display='none';
}
function movePopupsToBody() {
    ['namePopup', 'genYearModal', 'addEventPopup', 'searchPersonModal', 'slotActionMenu', 'popupOverlay'].forEach(id => {
        const el = document.getElementById(id);
        if(el && el.parentElement !== document.body) document.body.appendChild(el);
    });
}

// Actions Stubs (Les mêmes qu'avant)
function openNamePopup(el,d,h,r,v) {
    const p=document.getElementById('namePopup'); p.dataset.ctx=JSON.stringify({d,h,r});
    document.getElementById('namePopupSearch').value=""; renderNameList(NAMES_DB,v);
    const rect=el.getBoundingClientRect(); p.style.display='block';
    p.style.top=(rect.bottom+2)+'px'; p.style.left=rect.left+'px';
    if(rect.left+240>window.innerWidth) p.style.left=(window.innerWidth-250)+'px';
    if(rect.bottom+250>window.innerHeight) p.style.top=(rect.top-260)+'px';
    document.getElementById('popupOverlay').style.display='block';
    setTimeout(()=>document.getElementById('namePopupSearch').focus(),50);
    document.getElementById('namePopupSearch').oninput=(e)=>{
        const q=e.target.value.toLowerCase(); renderNameList(NAMES_DB.filter(n=>n.toLowerCase().includes(q)),v);
    };
}
function renderNameList(l,c){
    const d=document.getElementById('namePopupList'); d.innerHTML='<div class="p-3 text-muted small cursor-pointer hover-bg" onclick="submitName(\'\')">Effacer</div>';
    l.forEach(n=>{ d.innerHTML+=`<div class="p-2 px-3 cursor-pointer hover-bg ${n===c?'fw-bold bg-light text-primary':''}" onclick="submitName('${n}')">${n}</div>`; });
}
function submitName(n){
    const ctx=JSON.parse(document.getElementById('namePopup').dataset.ctx); closeAllPopups();
    const evt=PLANNING_DATA.find(e=>e.date===ctx.d && e.heure===ctx.h); if(evt){ if(!evt.assignments)evt.assignments={}; evt.assignments[ctx.r]=n; }
    refreshAllViews(); google.script.run.updatePlanningCell(ctx.d,ctx.h,ctx.r,n);
}
// Admin Actions
function openGenerateYearModal(){ document.getElementById('genYearModal').style.display='block'; document.getElementById('popupOverlay').style.display='block'; document.getElementById('genYearModal').style.position='fixed'; document.getElementById('genYearModal').style.top='50%'; document.getElementById('genYearModal').style.left='50%'; document.getElementById('genYearModal').style.transform='translate(-50%,-50%)'; document.getElementById('genYearInput').value=new Date().getFullYear(); }
function submitGenerateYear(){ const y=document.getElementById('genYearInput').value; google.script.run.withSuccessHandler(r=>{alert(r);closeAllPopups();initPlanningView()}).generateYearBackend(y); }
function openAddEventPopup(){ document.getElementById('addEventPopup').style.display='block'; document.getElementById('popupOverlay').style.display='block'; document.getElementById('addEventPopup').style.position='fixed'; document.getElementById('addEventPopup').style.top='50%'; document.getElementById('addEventPopup').style.left='50%'; document.getElementById('addEventPopup').style.transform='translate(-50%,-50%)'; document.getElementById('newEventDate').value=new Date().toISOString().split('T')[0]; }
function submitNewEvent(){ const d=document.getElementById('newEventDate').value; const t=document.getElementById('newEventTime').value; if(!d)return; const p=d.split('-'); google.script.run.withSuccessHandler(()=>initPlanningView()).createPlanningEvent(`${p[2]}/${p[1]}/${p[0]}`,t); closeAllPopups(); }
function openSlotMenu(el,d,h,t){ window.TARGET_SLOT={d,h,t}; const m=document.getElementById('slotActionMenu'); document.getElementById('slotActionTitle').innerText=d; m.style.display='block'; const r=el.getBoundingClientRect(); m.style.top=r.bottom+'px'; m.style.left=r.left+'px'; document.getElementById('popupOverlay').style.display='block'; }
function editSlotTime(){ const v=prompt('Heure:',window.TARGET_SLOT.h); if(v){google.script.run.withSuccessHandler(()=>initPlanningView()).updateEventHeader(window.TARGET_SLOT.d,window.TARGET_SLOT.h,'TIME',v); closeAllPopups();} }
function editSlotTitle(){ const v=prompt('Titre:',window.TARGET_SLOT.t); if(v){google.script.run.withSuccessHandler(()=>initPlanningView()).updateEventHeader(window.TARGET_SLOT.d,window.TARGET_SLOT.h,'TITLE',v); closeAllPopups();} }
function confirmDeleteSlot(){ if(confirm('Supprimer?')){google.script.run.withSuccessHandler(()=>{initPlanningView()}).deletePlanningEventBackend(window.TARGET_SLOT.d,window.TARGET_SLOT.h); closeAllPopups();} }
function openSearchPersonModal(){ document.getElementById('searchPersonModal').style.display='flex'; document.getElementById('popupOverlay').style.display='block'; document.getElementById('spInput').value=''; document.getElementById('spInput').focus(); handlePersonSearch(''); }
function handlePersonSearch(q){
    const c=document.getElementById('spResults'); c.innerHTML=''; const query=q.toLowerCase();
    let hits=[]; PLANNING_DATA.forEach(e=>{ for(let [r,n] of Object.entries(e.assignments)){ if(n&&n.toLowerCase().includes(query)) hits.push({d:e.date,r,n,obj:e}); } });
    if(hits.length===0){c.innerHTML='<div class="p-3 text-muted text-center">Rien</div>';return;}
    hits.forEach(h=>{ c.innerHTML+=`<div class="p-3 border-bottom hover-bg cursor-pointer" onclick="closeAllPopups();goToEvent('${h.d}','${h.h}')"><div class="fw-bold small">${h.d} • ${h.r}</div><div>${h.n}</div></div>`; });
}
function goToEvent(d,h) { const idx = PLANNING_DATA.findIndex(e => e.date === d && e.heure === h); if(idx > -1) { NEXT_CULT_INDEX = idx; forceScrollToNext(); } }
function handleKeyboardNav(e) {}
// --- ICON HELPER ---
function getRoleIconClass(roleName) {
    // On cherche le type dans la config si possible, sinon on devine par le nom
    const roleObj = ROLES_CONFIG.find(r => r.name === roleName);
    const type = roleObj ? (roleObj.type || "").toUpperCase() : roleName.toUpperCase();
    
    if(type.includes('LITURG') || roleName.includes('Mpitari')) return 'bi-book';
    if(type.includes('MUSI') || type.includes('CHANT')) return 'bi-music-note-beamed';
    if(type.includes('TECH') || type.includes('SON') || type.includes('PROJ')) return 'bi-sliders';
    if(type.includes('TRAD')) return 'bi-translate';
    if(type.includes('SEC') || type.includes('ADMIN')) return 'bi-pencil-square';
    if(type.includes('ACCUEIL')) return 'bi-emoji-smile';
    if(type.includes('VAKITENY')) return 'bi-journal-text'; // Spécifique lecture
    
    return 'bi-person'; // Défaut
}
</script>