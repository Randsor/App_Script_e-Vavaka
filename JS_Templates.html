<script>
  // --- VARIABLES GLOBALES ---
  let rolesList = []; 
  let CURRENT_TPL_DATA = null;
  let FANEKENA_CONTEXT_TPL = { blockIndex: -1 };

  // --- INITIALISATION ---
  document.addEventListener("DOMContentLoaded", function() {
    loadTemplatesList();
    loadRolesForTemplates();
    
    // Déplacement DOM
    ['insertMenu', 'menuOverlay', 'roleMenu'].forEach(id => {
        const el = document.getElementById(id);
        if (el && el.parentElement !== document.body) document.body.appendChild(el);
    });
    
    // Correction Click Outside
    const menuOverlay = document.getElementById('menuOverlay');
    if (menuOverlay) {
        menuOverlay.addEventListener('click', closeAllMenus);
    }

    initSortableTemplate();
  });

  // --- SORTABLE JS TEMPLATE ---
  function initSortableTemplate() {
      const el = document.getElementById('blocksContainer');
      if (el) {
          if(el._sortable) el._sortable.destroy();
          
          el._sortable = new Sortable(el, {
              animation: 300, 
              draggable: '.item-wrapper', 
              handle: '.drag-handle', 
              ghostClass: 'sortable-ghost', 
              chosenClass: 'sortable-chosen',
              dragClass: 'sortable-drag',
              onEnd: function(evt) { 
                  if (evt.oldIndex !== evt.newIndex) {
                    const item = DATA_TEMPLATE_BLOCKS.splice(evt.oldIndex, 1)[0]; 
                    DATA_TEMPLATE_BLOCKS.splice(evt.newIndex, 0, item); 
                    setDirty(true); // MODIF
                    renderSharedBlocks('blocksContainer', DATA_TEMPLATE_BLOCKS, 'TEMPLATE'); 
                  }
              } 
          });
      }
  }

  // --- CRUD TEMPLATES ---

  function saveTemplate() {
      const nomAdmin = safeGetValue('tplName');
      if(!nomAdmin) { alert("Nom obligatoire !"); return; }
      document.getElementById('saveStatus').innerText = "Sauvegarde...";

      const selectedRoles = [];
      document.querySelectorAll('.role-check:checked').forEach(chk => selectedRoles.push(chk.value));

      const templateData = { 
          settings: { 
              publicTitle: safeGetValue('commonTitleInput'), 
              subTitle: safeGetValue('commonSubtitleInput'), 
              requiredRoles: selectedRoles 
          }, 
          blocks: DATA_TEMPLATE_BLOCKS 
      };

      const form = { rowIndex: safeGetValue('tplRowIndex'), nom: nomAdmin, structure: JSON.stringify(templateData) };
      
      if(CURRENT_TPL_DATA) { 
          CURRENT_TPL_DATA.nom = nomAdmin; 
          CURRENT_TPL_DATA.parsedSettings = templateData.settings; 
      } 
      
      google.script.run.withSuccessHandler(msg => {
          setDirty(false); // RAZ
          document.getElementById('saveStatus').innerText = "Enregistré";
          loadTemplatesList();
      }).saveTemplateBackend(form);
  }

  function loadTemplate(id) { 
      guardNavigation(() => {
          APP_CONTEXT = 'TEMPLATE'; 
          showMobileEditor(); 
          
          const sharedHeader = document.getElementById('sharedHeaderRoot'); 
          const placeholder = document.getElementById('templateHeaderPlaceholder'); 
          if(sharedHeader && placeholder) placeholder.appendChild(sharedHeader);
          if(typeof resetSharedHeader === 'function') resetSharedHeader();
          
          google.script.run.withSuccessHandler(tpl => { 
              CURRENT_TPL_DATA = tpl; 
              try { 
                  const parsed = JSON.parse(tpl.structure); 
                  CURRENT_TPL_DATA.parsedSettings = parsed.settings || {}; 
                  DATA_TEMPLATE_BLOCKS = parsed.blocks || []; 
              } catch(e) { 
                  CURRENT_TPL_DATA.parsedSettings = {}; 
                  DATA_TEMPLATE_BLOCKS = []; 
              }
              
              restoreTemplateHeader(); 
              renderSharedBlocks('blocksContainer', DATA_TEMPLATE_BLOCKS, 'TEMPLATE');
              initSortableTemplate();
          }).getTemplateDetails(id); 
      });
  }

  function createNewTemplate() { 
      guardNavigation(() => {
          APP_CONTEXT = 'TEMPLATE'; 
          const sharedHeader = document.getElementById('sharedHeaderRoot'); 
          const placeholder = document.getElementById('templateHeaderPlaceholder'); 
          if(sharedHeader && placeholder) placeholder.appendChild(sharedHeader);
          if(typeof resetSharedHeader === 'function') resetSharedHeader(); 
          showMobileEditor(); 
          
          CURRENT_TPL_DATA = { id: "", rowIndex: "", nom: "", parsedSettings: { publicTitle: "FANOMPOAM-PIVAVAHANA" } }; 
          DATA_TEMPLATE_BLOCKS = []; 
          setDirty(false); 
          
          restoreTemplateHeader(); 
          renderSharedBlocks('blocksContainer', DATA_TEMPLATE_BLOCKS, 'TEMPLATE');
          const nameInput = document.getElementById('tplName'); if(nameInput) nameInput.focus(); 
      });
  }

  function restoreTemplateHeader() { 
      if(!CURRENT_TPL_DATA) return; 
      safeSetValue('tplId', CURRENT_TPL_DATA.id); 
      safeSetValue('tplRowIndex', CURRENT_TPL_DATA.rowIndex); 
      safeSetValue('tplName', CURRENT_TPL_DATA.nom); 
      document.getElementById('headerDateDisplay').innerText = "DATE AUTOMATIQUE"; 
      
      const settings = CURRENT_TPL_DATA.parsedSettings || {}; 
      safeSetValue('commonTitleInput', settings.publicTitle || ""); 
      safeSetValue('commonSubtitleInput', settings.subTitle || ""); 
      renderSharedRoles('TEMPLATE', rolesList, settings.requiredRoles || []); 
  }
  
  function loadTemplatesList() { 
      const container = document.getElementById('templatesList');
      
      // SKELETON LOADER (5 lignes fantômes)
      let skelHtml = '';
      for(let i=0; i<5; i++) {
          skelHtml += `<div class="nav-skeleton-item"><div class="nav-sk-line" style="width: ${Math.floor(Math.random() * (80 - 40) + 40)}%"></div></div>`;
      }
      container.innerHTML = skelHtml;
      
      google.script.run.withSuccessHandler(list => { 
          container.innerHTML = ""; 
          
          if(list.length === 0) {
              container.innerHTML = '<div class="text-center py-5 text-muted small fst-italic">Aucun modèle.</div>';
              return;
          }

          list.forEach(t => { 
              const btn = document.createElement('div');
              btn.className = "nav-saas-item";
              if (CURRENT_TPL_DATA && String(CURRENT_TPL_DATA.id) === String(t.id)) btn.classList.add('active');

              btn.innerHTML = `<span>${t.nom}</span><i class="bi bi-chevron-right small opacity-25" style="font-size:10px;"></i>`;
              
              btn.onclick = () => {
                  document.querySelectorAll('.nav-saas-item').forEach(el => el.classList.remove('active'));
                  btn.classList.add('active');
                  loadTemplate(t.id);
              };
              container.appendChild(btn);
          }); 
      }).getTemplatesList(); 
  }
  
  function loadRolesForTemplates() { 
      google.script.run.withSuccessHandler(data => { rolesList = data.roles || []; }).getConfigData(); 
  }
  
  // --- FANEKENA SELECTOR TEMPLATE ---
  
  function openFanekenaSelectorTemplate(index) { 
      FANEKENA_CONTEXT_TPL.blockIndex = index; 
      document.getElementById('fanekenaSelectorModalTpl').style.display = 'flex'; 
      document.getElementById('menuOverlay').style.display = 'block'; 
      const container = document.getElementById('fanekenaSelectListTpl'); 
      container.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div></div>'; 
      
      google.script.run.withSuccessHandler(list => { 
          container.innerHTML = ""; 
          if(list.length === 0) { 
              container.innerHTML = '<div class="p-3 text-muted small text-center">Aucun texte disponible.</div>'; 
              return; 
          } 
          list.forEach(item => { 
              const div = document.createElement('div'); div.className = "song-item"; 
              div.innerHTML = '<div class="fw-bold text-dark" style="font-size:13px;">' + item.titre + '</div><i class="bi bi-chevron-right small text-muted ms-2"></i>'; 
              div.onclick = function() { selectFanekenaTpl(item.id, this); }; 
              container.appendChild(div); 
          }); 
      }).getFanekenaList(); 
  }
  
  function selectFanekenaTpl(id, clickedElement) { 
      if(clickedElement) { 
          clickedElement.innerHTML = '<div class="d-flex align-items-center gap-2 text-primary fw-bold"><div class="spinner-border spinner-border-sm"></div><span>Insertion...</span></div>'; 
          clickedElement.style.pointerEvents = 'none'; 
          const siblings = clickedElement.parentElement.children; 
          for(let sib of siblings) if(sib !== clickedElement) sib.style.opacity = '0.5'; 
      } 
      
      const idx = FANEKENA_CONTEXT_TPL.blockIndex; 
      if (idx > -1 && DATA_TEMPLATE_BLOCKS[idx]) { 
          google.script.run.withSuccessHandler(data => { 
              if(!DATA_TEMPLATE_BLOCKS[idx].data) DATA_TEMPLATE_BLOCKS[idx].data = {}; 
              DATA_TEMPLATE_BLOCKS[idx].data.id = data.id; 
              DATA_TEMPLATE_BLOCKS[idx].data.titre = data.titre; 
              DATA_TEMPLATE_BLOCKS[idx].data.contenu_mg = data.contenu_mg; 
              DATA_TEMPLATE_BLOCKS[idx].data.contenu_fr = data.contenu_fr; 
              setDirty(true); // MODIF
              renderSharedBlocks('blocksContainer', DATA_TEMPLATE_BLOCKS, 'TEMPLATE'); 
              closeAllModalsTpl(); 
          }).getFanekenaDetails(id); 
      } 
  }
  
  function closeAllModalsTpl() { 
      document.getElementById('fanekenaSelectorModalTpl').style.display = 'none'; 
      document.getElementById('menuOverlay').style.display = 'none'; 
  }
  
  function deleteCurrentTemplate() { 
      if(!confirm("Supprimer ?")) return; 
      const id = safeGetValue('tplId'); 
      google.script.run.withSuccessHandler(msg => { 
          loadTemplatesList(); 
          createNewTemplate(); 
      }).deleteTemplateBackend(id); 
  }
  
  function safeSetValue(id, value) { const el = document.getElementById(id); if (el) el.value = value || ""; }
  function safeGetValue(id) { const el = document.getElementById(id); return el ? el.value : ""; }
  
  function showMobileEditor() { 
      if (window.innerWidth < 768) { 
          document.getElementById('panel-list').classList.add('d-none'); 
          document.getElementById('panel-editor').classList.remove('d-none'); 
      } else { 
          document.getElementById('panel-list').classList.remove('d-none'); 
          document.getElementById('panel-editor').classList.remove('d-none'); 
          document.getElementById('emptyStatePanel').classList.add('d-none'); 
      } 
      document.getElementById('panel-editor').style.setProperty('display', 'flex', 'important'); 
  }
  
  function showMobileList() { 
      document.getElementById('panel-list').classList.remove('d-none'); 
      document.getElementById('panel-editor').classList.add('d-none'); 
  }
</script>
<style>.sortable-ghost { opacity: 0.2; transform: scale(0.95); }</style>