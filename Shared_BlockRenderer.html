<script>
/**
 * MOTEUR DE RENDU UNIFIÉ - BLOCS PROGRAMME & TEMPLATES
 * Version Complète & Sécurisée (Fix: Justification, Marges, Commentaires, Texte Libre)
 */

// --- GETTERS DE CONTEXTE ---
function getActiveDataArray() { 
    return (APP_CONTEXT === 'TEMPLATE') ? DATA_TEMPLATE_BLOCKS : DATA_PROGRAMME_BLOCKS; 
}

function getActiveContainerId() { 
    return (APP_CONTEXT === 'TEMPLATE') ? 'blocksContainer' : 'docBlocksContainer'; 
}

function refreshActiveView() { 
    const data = getActiveDataArray(); 
    const containerId = getActiveContainerId(); 
    renderSharedBlocks(containerId, data, APP_CONTEXT); 
}

// --- ACTIONS CRUD SUR LES BLOCS ---

function removeBlock(index) { 
    const data = getActiveDataArray(); 
    data.splice(index, 1); 
    setDirty(true); 
    refreshActiveView(); 
}

function updateBlockField(index, field, value) { 
    const data = getActiveDataArray(); 
    if(data[index]) {
        data[index][field] = value;
        setDirty(true);
    }
}

function updateBlockDataField(index, field, value) { 
    const data = getActiveDataArray(); 
    if(data[index]) { 
        if(!data[index].data) data[index].data = {}; 
        data[index].data[field] = value; 
        setDirty(true);
    } 
    // Si on change le mode (ex: Chant Recherche -> Fixe), on rafraîchit l'affichage
    if(field === 'mode') refreshActiveView(); 
}

function resetSongBlock(index) {
    const data = getActiveDataArray();
    if(data[index]) { 
        data[index].data = { mode: 'recherche' }; 
        setDirty(true);
        refreshActiveView(); 
    }
}

// --- GESTION DES MENUS D'INSERTION ---

function insertBlock(type) {
    if(typeof closeAllMenus === 'function') closeAllMenus();
    
    const data = getActiveDataArray();
    let insertIdx = (typeof window.insertIndex !== 'undefined') ? window.insertIndex : -1;
    
    // Structure par défaut selon le type
    let newBlock = { type: type, label_mg: "", label_fr: "", role: "", data: {} };
    
    if(type === 'TITRE') { newBlock.label_mg = "LOHATENIM-PIZARANA"; newBlock.label_fr = "Titre de section"; }
    if(type === 'CHANT') { newBlock.label_mg = "HIRA"; newBlock.label_fr = "Chant"; newBlock.data.mode = 'recherche'; }
    if(type === 'FANEKENA') { newBlock.label_mg = "FANEKEM-PINOANA"; newBlock.label_fr = "Confession de foi"; }
    if(type === 'LECTURE') { newBlock.label_mg = "VAKITENY"; newBlock.label_fr = "Lecture Biblique"; }
    if(type === 'LITURGIE') { newBlock.label_mg = "FIZARANA LITORJIKA"; newBlock.label_fr = "Rubrique liturgique"; }
    if(type === 'PREDICATION') { newBlock.label_mg = "TORITENY"; newBlock.label_fr = "Prédication"; }
    if(type === 'PRIERE') { newBlock.label_mg = "VAVAKA"; newBlock.label_fr = "Prière"; }
    if(type === 'ANNONCE') { newBlock.label_mg = "FILAZAN-DRAHARAHA"; newBlock.label_fr = "Annonces"; }
    if(type === 'LIBRE') { newBlock.label_mg = "INTERVENTION"; newBlock.label_fr = "Section libre"; }
    if(type === 'TEXTE_LIBRE') { newBlock.label_mg = ""; newBlock.label_fr = ""; }
    
    // Insertion à la position demandée ou à la fin
    if (insertIdx === -1) data.push(newBlock); 
    else data.splice(insertIdx + 1, 0, newBlock);
    
    setDirty(true);
    refreshActiveView();
}

// Ouvre le menu d'insertion sous le bouton "+"
function openInsertMenu(index, btnElement, event) { 
    window.insertIndex = index; 
    openMenuAtMouse('insertMenu', btnElement, event); 
}

// --- GESTION DU MENU RÔLES ---

function openRoleMenu(index, btnElement, event) {
    window.roleEditIndex = index;
    
    // Récupération de la liste des rôles selon le contexte (Template ou Programme)
    let rawRoles = [];
    if(APP_CONTEXT === 'TEMPLATE' && typeof rolesList !== 'undefined') rawRoles = rolesList;
    else if(typeof rolesListConfig !== 'undefined') rawRoles = rolesListConfig;
    
    const menu = document.getElementById('roleMenu'); 
    menu.classList.add('scrollable-menu');
    
    // Groupement des rôles par type
    const groups = {}; 
    const noTypeKey = "AUTRES"; 
    const seenNames = new Set();
    const ALLOWED_TYPES = ['liturgie', 'secrétaire', 'secretaire', 'pasteur', 'diacre']; 
    
    rawRoles.forEach(r => {
        if (!r.name || r.name.trim() === "") return;
        if (seenNames.has(r.name)) return;
        
        seenNames.add(r.name);
        const type = (r.type && r.type.trim() !== "") ? r.type : noTypeKey;
        if(!groups[type]) groups[type] = [];
        groups[type].push(r);
    });
    
    let html = '<div class="dropdown-item text-muted fst-italic py-2 border-bottom" onclick="setSharedBlockRole(\'\')"><i class="bi bi-x-circle me-2"></i>(Aucun rôle)</div>';
    
    const sortedKeys = Object.keys(groups).sort();
    if(sortedKeys.includes(noTypeKey)) { 
        const idx = sortedKeys.indexOf(noTypeKey); 
        sortedKeys.splice(idx, 1); 
        sortedKeys.push(noTypeKey); 
    }
    
    sortedKeys.forEach(groupName => {
        html += '<h6 class="dropdown-header dropdown-header-sticky mt-2 mb-1 fw-bold bg-light text-uppercase" style="font-size:10px; letter-spacing:1px;">' + groupName + '</h6>';
        groups[groupName].forEach(r => { 
            html += '<div class="dropdown-item py-1" onclick="setSharedBlockRole(\'' + r.name + '\')" style="cursor:pointer;"><span style="font-size:13px;">' + r.name + '</span></div>'; 
        });
    });
    
    if (rawRoles.length === 0) html = '<div class="p-3 text-center text-muted small">Aucun rôle configuré.</div>';
    menu.innerHTML = html;
    
    openMenuAtElementGeneric('roleMenu', btnElement);
}

function setSharedBlockRole(roleName) { 
    const data = getActiveDataArray(); 
    const idx = window.roleEditIndex; 
    if (idx > -1 && data[idx]) { 
        data[idx].role = roleName; 
        setDirty(true);
        refreshActiveView(); 
    } 
    closeAllMenus(); 
}

// --- UTILITAIRES DE POSITIONNEMENT MENU ---

function openMenuAtMouse(menuId, element, event) {
    if(typeof closeAllMenus === 'function') closeAllMenus(); 
    
    const menu = document.getElementById(menuId);
    const overlay = document.getElementById('menuOverlay');
    if(overlay) overlay.style.display = 'block';
    
    if(menu) {
        menu.style.display = 'block';
        menu.style.visibility = 'hidden'; 
        
        const rect = element.getBoundingClientRect();
        let topPos = rect.bottom;
        let leftPos = event && event.clientX ? event.clientX : rect.left + (rect.width / 2);
        
        const menuWidth = menu.offsetWidth || 180;
        if (leftPos + menuWidth > window.innerWidth - 10) leftPos = window.innerWidth - menuWidth - 10;
        const menuHeight = menu.offsetHeight || 200;
        if (topPos + menuHeight > window.innerHeight - 10) topPos = rect.top - menuHeight;

        menu.style.top = topPos + 'px';
        menu.style.left = leftPos + 'px';
        menu.style.position = 'fixed';
        menu.style.visibility = 'visible';
    }
}

function openMenuAtElementGeneric(menuId, element) { 
    openMenuAtMouse(menuId, element, null); 
}

// ====================================================================================
//                      RENDERER PRINCIPAL (GÉNÉRATION HTML)
// ====================================================================================

function renderSharedBlocks(containerId, blocks, context) {
    const container = document.getElementById(containerId);
    if(!container) return;
    container.innerHTML = "";
    
    // --- GESTION ETAT VIDE ---
    if (blocks.length === 0) {
        if(context === 'TEMPLATE') { 
            const msg = document.getElementById('emptyTplMsg'); 
            if(msg) msg.classList.remove('hidden'); 
        } else { 
            container.innerHTML = '<div class="text-center text-muted fst-italic py-5">Aucun élément dans le programme.</div>'; 
        }
        return;
    }
    if(context === 'TEMPLATE') { 
        const msg = document.getElementById('emptyTplMsg'); 
        if(msg) msg.classList.add('hidden'); 
    }

    blocks.forEach((block, index) => {
        
        // 1. Définition des couleurs de badge
        let badgeClass = "bg-secondary-subtle text-secondary";
        if (block.type === 'CHANT') badgeClass = "bg-primary-subtle text-primary";
        if (block.type === 'FANEKENA') badgeClass = "bg-primary-subtle text-primary border-primary";
        if (block.type === 'LECTURE') badgeClass = "bg-success-subtle text-success";
        if (block.type === 'PREDICATION') badgeClass = "bg-danger-subtle text-danger";
        if (block.type === 'LITURGIE') badgeClass = "bg-warning-subtle text-warning-emphasis";
        if (block.type === 'PRIERE') badgeClass = "bg-info-subtle text-info-emphasis";
        if (block.type === 'ANNONCE') badgeClass = "bg-dark-subtle text-dark";
        if (block.type === 'TITRE') badgeClass = "bg-light text-secondary border";

        // 2. Bouton Rôle (Sauf pour Titre et Chant)
        let roleHTML = "";
        if (block.type !== 'TITRE' && block.type !== 'CHANT') {
            let displayRole = block.role || "(Sans rôle)";
            let roleClass = block.role ? "text-dark fw-medium" : "text-muted fst-italic";
            roleHTML = `<div class="cursor-pointer ${roleClass} me-2 d-flex align-items-center gap-1 small" 
                             onclick="openRoleMenu(${index}, this, event)" 
                             style="font-size:0.75rem; white-space:nowrap;">
                             ${displayRole} <i class="bi bi-chevron-down opacity-50" style="font-size:8px;"></i>
                        </div>`;
        }

        let extraFields = "";
        
        // --- STYLES ---
        // Style Standard (Gauche)
        let contentStyle = 'style="font-size:14px; resize:none; overflow-y:hidden;"';
        // Style Justifié (Lecture, Texte, etc.) - Nouveau
        let styleJustified = 'style="font-size:14px; resize:none; overflow-y:hidden; text-align:justify;"';
        
        // --- CHANT (COLLÉ) ---
        if (block.type === 'CHANT') {
             let titleRow = '<div class="w-100" style="padding-right: 70px;">';
             // m-0 pour coller les titres
             titleRow += `<input type="text" class="form-control doc-borderless input-mg p-0 m-0" style="width: 100%;" value="${block.label_mg}" placeholder="TITRE MG" onchange="updateBlockField(${index}, 'label_mg', this.value)">`;
             titleRow += `<input type="text" class="form-control doc-borderless input-fr p-0 m-0" style="width: 100%;" value="${block.label_fr}" placeholder="Titre FR" onchange="updateBlockField(${index}, 'label_fr', this.value)">`;
             titleRow += '</div>';
             
             let content = "";
             let mode = block.data?.mode || "recherche";
             
             if (mode === 'fixe' || block.data?.paroles_fixe) {
                 let songInfo = "";
                 let isFromDB = !!block.data?.id;
                 let readonlyAttr = isFromDB ? "readonly" : "";
                 let bgClass = isFromDB ? "bg-light" : "bg-white";
                 
                 if(isFromDB && block.data?.recueil) {
                     let numStr = block.data.numero;
                     let formattedNum = (block.data.recueil === 'Fihirana') ? String(numStr).padStart(3, '0') : block.data.recueil.substring(0,2).toUpperCase() + ' ' + numStr;
                     let tonaliteHtml = block.data.tonalite ? `<span class="ms-2 border border-secondary text-secondary rounded fw-bold px-2" style="font-size:11px !important; padding:1px 4px; background-color:#fff;">${block.data.tonalite}</span>` : '';
                     let stanzaDisplay = (block.data.sequenceSummary && block.data.sequenceSummary !== 'Tout') ? `<span class="text-secondary ms-1" style="font-size:13px; font-weight:400;">: ${block.data.sequenceSummary}</span>` : '';

                     songInfo = `<div class="mt-1 mb-1 d-flex align-items-center justify-content-between"><div class="d-flex align-items-center gap-2 flex-wrap"><span class="fw-bold text-primary" style="font-size:15px;">${formattedNum}</span>${stanzaDisplay}<div class="vr mx-1 opacity-25"></div><div class="small fw-bold text-dark text-truncate" style="max-width:250px;">${block.data.titre}</div>${tonaliteHtml}</div><button class="btn btn-sm bg-white border text-secondary shadow-sm py-0 px-2" style="font-size:11px;" onclick="openSongSelector(${index})">Changer</button></div>`;
                 }
                 
                 content = songInfo;
                 content += `<div class="row g-2 mt-1 border-start ps-2 ms-1"><div class="col-12 col-md-6"><textarea class="form-control doc-borderless ${bgClass}" rows="2" ${contentStyle} ${readonlyAttr} placeholder="Paroles MG..." oninput="autoResize(this)" onchange="updateBlockDataField(${index}, 'paroles_fixe', this.value)">${block.data?.paroles_fixe || ''}</textarea></div><div class="col-12 col-md-6"><textarea class="form-control doc-borderless text-secondary ${bgClass}" rows="2" ${contentStyle} ${readonlyAttr} placeholder="Traduction..." oninput="autoResize(this)" onchange="updateBlockDataField(${index}, 'paroles_fr_fixe', this.value)">${block.data?.paroles_fr_fixe || ''}</textarea></div></div>`;
             } else {
                 content = `<div class="d-grid gap-2 d-md-flex mt-2"><button class="btn btn-sm bg-white text-dark shadow-sm d-flex align-items-center gap-2 px-3 border" onclick="openSongSelector(${index})"><i class="bi bi-search" style="color:#999;"></i> Choisir dans la liste</button><button class="btn btn-sm bg-white text-dark shadow-sm d-flex align-items-center gap-2 px-3 border" onclick="updateBlockDataField(${index}, 'mode', 'fixe')"><i class="bi bi-pencil-square" style="color:#999;"></i> Saisie libre</button></div>`;
             }
             extraFields = '<div>' + titleRow + content + '</div>';
        }
        
        // --- FANEKENA (JUSTIFIÉ) ---
        else if (block.type === 'FANEKENA') {
            let isFilled = block.data && block.data.id;
            let clickAction = (context === 'TEMPLATE') ? `openFanekenaSelectorTemplate(${index})` : `openFanekenaSelectorProgramme(${index})`;
            
            let selectorHtml = !isFilled ? 
                `<div class="mt-2"><button class="btn btn-sm bg-white text-dark shadow-sm d-flex align-items-center gap-2 px-3 border" onclick="${clickAction}"><i class="bi bi-search" style="color:#999;"></i> Choisir FANEKEM-PINOANA</button></div>` :
                `<div class="d-flex justify-content-between align-items-center mb-2 pt-1"><span class="fw-bold text-dark" style="font-size:13px; text-transform:uppercase; letter-spacing:0.5px;">${block.data.titre}</span><button class="btn btn-sm bg-white border text-secondary shadow-sm py-0 px-2" style="font-size:11px;" onclick="${clickAction}">Changer</button></div>`;
            
            // Texte justifié
            let txtMG = `<textarea class="form-control doc-borderless" rows="2" ${styleJustified} placeholder="Texte MG..." oninput="autoResize(this)" onchange="updateBlockDataField(${index}, 'contenu_mg', this.value)">${block.data?.contenu_mg || ''}</textarea>`;
            let txtFR = `<textarea class="form-control doc-borderless text-secondary" rows="2" ${styleJustified} placeholder="Texte FR..." oninput="autoResize(this)" onchange="updateBlockDataField(${index}, 'contenu_fr', this.value)">${block.data?.contenu_fr || ''}</textarea>`;
            
            extraFields = `<div class="mt-1 ps-3 border-start border-2 border-primary border-opacity-25">${selectorHtml}<div class="row g-2"><div class="col-12 col-md-6">${txtMG}</div><div class="col-12 col-md-6">${txtFR}</div></div></div>`;
        }
        
        // --- LECTURE (TITRES COLLÉS + TEXTE JUSTIFIÉ) ---
        else if (block.type === 'LECTURE') {
            extraFields = '<div class="row g-3 mt-1 border-start ps-2 ms-1">';
            // COLONNE MG : m-0 sur titre, styleJustified sur texte
            extraFields += `<div class="col-12 col-md-6">
                <input type="text" class="form-control doc-borderless fw-bold m-0" ${contentStyle} placeholder="Toko sy andininy" value="${block.data?.ref_mg || ''}" onchange="updateBlockDataField(${index}, 'ref_mg', this.value)">
                <textarea class="form-control doc-borderless" rows="3" ${styleJustified} placeholder="Texte Biblique MG..." oninput="autoResize(this)" onchange="updateBlockDataField(${index}, 'texte_mg', this.value)">${block.data?.texte_mg || ''}</textarea>
            </div>`;
            // COLONNE FR : m-0 sur titre, styleJustified sur texte
            extraFields += `<div class="col-12 col-md-6">
                <input type="text" class="form-control doc-borderless fw-bold text-secondary m-0" ${contentStyle} placeholder="Référence biblique" value="${block.data?.ref_fr || ''}" onchange="updateBlockDataField(${index}, 'ref_fr', this.value)">
                <textarea class="form-control doc-borderless text-secondary" rows="3" ${styleJustified} placeholder="Texte Biblique FR..." oninput="autoResize(this)" onchange="updateBlockDataField(${index}, 'texte_fr', this.value)">${block.data?.texte_fr || ''}</textarea>
            </div>`;
            extraFields += '</div>';
        }
        
        // --- AUTRES BLOCS (LITURGIE, PRIERE, TEXTE LIBRE...) (JUSTIFIÉS) ---
        else if (['LITURGIE', 'LIBRE', 'PRIERE', 'TEXTE_LIBRE'].includes(block.type)) {
            let versetInput = (block.type === 'LITURGIE') ? `<input type="text" class="form-control doc-borderless fw-bold text-primary mb-1" ${contentStyle} placeholder="Verset..." value="${block.data?.verset || ''}" onchange="updateBlockDataField(${index}, 'verset', this.value)">` : '';
            
            // Texte justifié
            let txtMG = `<textarea class="form-control doc-borderless" rows="2" ${styleJustified} placeholder="Texte MG..." oninput="autoResize(this)" onchange="updateBlockDataField(${index}, 'texte_mg', this.value)">${block.data?.texte_mg || ''}</textarea>`;
            let txtFR = `<textarea class="form-control doc-borderless text-secondary" rows="2" ${styleJustified} placeholder="Texte FR..." oninput="autoResize(this)" onchange="updateBlockDataField(${index}, 'texte_fr', this.value)">${block.data?.texte_fr || ''}</textarea>`;
            
            if(block.type === 'TEXTE_LIBRE') {
                // Espace ajusté pour ne pas chevaucher les boutons (30px)
                extraFields = `<div class="row g-2" style="padding-top: 30px;"><div class="col-12 col-md-6">${txtMG}</div><div class="col-12 col-md-6">${txtFR}</div></div>`;
            } else {
                // Ajout Champ Commentaire pour LITURGIE
                let commentInput = "";
                if (block.type === 'LITURGIE') {
                    commentInput = `<input type="text" class="form-control doc-borderless text-muted fst-italic mt-1" style="font-size:13px;" placeholder="Commentaire (facultatif)..." value="${block.data?.comment || ''}" onchange="updateBlockDataField(${index}, 'comment', this.value)">`;
                }
                extraFields = `<div class="mt-1 ps-3 border-start border-2 border-light">${versetInput}<div class="row g-2"><div class="col-12 col-md-6">${txtMG}</div><div class="col-12 col-md-6">${txtFR}</div></div>${commentInput}</div>`;
            }
        }
        else if (block.type === 'TITRE') extraFields = `<input type="text" class="form-control doc-borderless text-muted fst-italic mt-0" style="font-size:14px;" placeholder="Commentaire (facultatif)..." value="${block.data?.comment || ''}" onchange="updateBlockDataField(${index}, 'comment', this.value)">`; 
         else if (block.type === 'PREDICATION') {
            if (context === 'PROGRAMME') {
                // Récupération des valeurs actuelles de l'en-tête (si disponibles)
                let tMG = document.getElementById('docThemeMG') ? document.getElementById('docThemeMG').value : "";
                let tFR = document.getElementById('docThemeFR') ? document.getElementById('docThemeFR').value : "";
                
                // Fallbacks visuels
                if(!tMG) tMG = "(Thème MG non défini)";
                if(!tFR) tFR = "(Thème FR non défini)";

                // Structure avec classes miroirs pour mise à jour JS live
                extraFields = `<div class="mt-2 ps-3 border-start border-4 border-danger border-opacity-25">
                    <div class="fw-bold text-dark mirror-theme-mg" style="font-size:14px;">${tMG}</div>
                    <div class="text-secondary fst-italic mirror-theme-fr" style="font-size:13px;">${tFR}</div>
                </div>`;
            } else {
                // Mode Template (Pas de données live)
                extraFields = '<div class="mt-1 d-flex gap-2 text-muted small"><span class="badge bg-light text-secondary border fw-normal">Le thème du culte s\'affichera ici</span></div>'; 
            }
        }
        else if (block.type === 'ANNONCE') extraFields = '<div class="mt-1 text-muted small fst-italic ms-1" style="font-size:12px;"><i class="bi bi-link-45deg me-1"></i>Lien automatique Module Nouvelles</div>'; 

        // 3. Contenu Principal (Inputs Titre GÉNÉRIQUES COLLÉS)
        // m-0 ajouté ici aussi pour tous les blocs génériques
        const mainContent = (block.type === 'CHANT' || block.type === 'TEXTE_LIBRE') 
            ? extraFields 
            : `<input type="text" class="form-control doc-borderless input-mg p-0 m-0" value="${block.label_mg}" placeholder="TITRE MG" onchange="updateBlockField(${index}, 'label_mg', this.value)">
               <input type="text" class="form-control doc-borderless input-fr p-0 m-0" value="${block.label_fr}" placeholder="Titre FR" onchange="updateBlockField(${index}, 'label_fr', this.value)">`;

        const bottomContent = (block.type !== 'CHANT' && block.type !== 'TEXTE_LIBRE') ? `<div class="ps-1">${extraFields}</div>` : '';
        
        // Bouton Reset pour le chant
        let resetBtn = (block.type === 'CHANT' && (block.data?.id || block.data?.mode === 'fixe')) ? `<i class="bi bi-arrow-counterclockwise text-secondary opacity-50 hover-opacity-100 cursor-pointer small ms-2" onclick="resetSongBlock(${index})" title="Réinitialiser le chant"></i>` : "";

        // 4. ASSEMBLAGE FINAL DE LA CARTE HTML
        // Note: pour TEXTE_LIBRE, on retire le padding-right du conteneur principal pour qu'il prenne toute la largeur
        container.innerHTML += `
        <div class="item-wrapper group-bloc position-relative hover-bg" data-index="${index}" style="display: block !important; margin-bottom: 13px !important; border-bottom: none !important;">
            
            <!-- ACTION ABSOLUE TOP RIGHT -->
            <div class="position-absolute top-0 end-0 mt-2 me-2 d-flex align-items-center" style="z-index: 5;">
                ${roleHTML}
                <span class="badge rounded-1 fw-normal border ${badgeClass}" style="font-size:9px; padding: 2px 4px;">${block.type}</span>
                ${resetBtn}
                <i class="bi bi-trash3 text-secondary opacity-25 cursor-pointer small ms-2 no-print btn-action-danger" onclick="removeBlock(${index})" title="Supprimer"></i>
            </div>

            <div class="d-flex align-items-start gap-2 ps-0 pe-2 w-100 py-1">
              <div class="drag-handle pt-1 no-print" style="width: 30px; cursor: grab;" title="Déplacer"><i class="bi bi-grip-vertical"></i></div>
              <div class="flex-grow-1" style="min-width: 0;">
                 <div style="${(block.type !== 'CHANT' && block.type !== 'TEXTE_LIBRE' ? 'padding-right: 70px;' : '')}">
                    ${mainContent}
                 </div>
                 ${bottomContent}
              </div>
            </div>
            <div class="add-zone-line no-print" style="bottom: -7px;" onclick="openInsertMenu(${index}, this, event)"><div class="plus-icon"><i class="bi bi-plus"></i></div></div>
        </div>`;
    });
    
    // Auto-resize de tous les textareas après rendu
    document.querySelectorAll('textarea').forEach(el => autoResize(el));
}

// --- GLOBAL MENU MANAGER (FIX CAUSE RACINE) ---
function closeAllMenus() {
    // Liste consolidée de tous les menus flottants possibles
    const ids = [
        'insertMenu', 
        'roleMenu', 
        'menuOverlay', 
        'fanekenaSelectorModalTpl' // Spécifique Template (ne fera plus planter Programme)
    ];

    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none'; // Le "if (el)" est la clé du fix
    });
}

</script>