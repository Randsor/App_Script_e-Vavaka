<script>
  let FNK_PENDING_ACTION = null;

  function initFanekenaView() {
      loadFanekenaList();
  }

  // --- MOBILE NAVIGATION HELPERS ---
  function showFnkMobileEditor() {
      if (window.innerWidth < 768) {
          document.getElementById('fnk-panel-list').classList.add('d-none');
          document.getElementById('fnk-panel-editor').classList.remove('d-none');
          document.getElementById('fnk-panel-editor').classList.add('d-flex');
      }
  }

  function showFnkMobileList() {
      if (window.innerWidth < 768) {
          document.getElementById('fnk-panel-list').classList.remove('d-none');
          document.getElementById('fnk-panel-editor').classList.add('d-none');
          document.getElementById('fnk-panel-editor').classList.remove('d-flex');
      }
  }

  // --- DIRTY STATE & NAVIGATION MANAGER ---
  function markFnkDirty() {
      // On utilise le système global défini dans Global_JS
      if(!APP_IS_DIRTY) {
          setDirty(true);
          // Le changement visuel du bouton est géré automatiquement par Global_JS
          // Mais on garde la classe spécifique locale pour le style css
          document.getElementById('fnk-panel-editor').classList.add('is-dirty');
      }
  }

  function resetFnkDirty() {
      setDirty(false); // Reset Global
      document.getElementById('fnk-panel-editor').classList.remove('is-dirty');
  }

  function handleFnkNavigation(action, payload) {
      // Protection Navigation via le système Global
      guardNavigation(() => {
          executeFnkNavigation(action, payload);
      });
  }

  function executeFnkNavigation(action, payload) {
      if (action === 'NEW') {
          createNewFanekena();
          showFnkMobileEditor();
      } else if (action === 'LOAD') {
          loadFanekenaDetails(payload.id, payload.el);
          showFnkMobileEditor();
      } else if (action === 'BACK_LIST') {
          showFnkMobileList();
          resetFnkDirty();
      }
  }

  // --- LOGIQUE METIER ---

  function loadFanekenaList() {
      const container = document.getElementById('fanekenaListContainer');
      container.innerHTML = '<div class="text-center py-4 text-muted"><div class="spinner-border spinner-border-sm"></div></div>';
      
      google.script.run.withSuccessHandler(list => {
          container.innerHTML = "";
          if(list.length === 0) {
              container.innerHTML = '<div class="p-3 text-muted small text-center">Aucun texte enregistré.</div>';
              return;
          }
          list.forEach(item => {
              const div = document.createElement('div');
              div.className = "list-item-f";
              div.innerText = item.titre || "(Sans titre)";
              div.onclick = () => handleFnkNavigation('LOAD', { id: item.id, el: div });
              container.appendChild(div);
          });
      }).getFanekenaList();
  }

  function loadFanekenaDetails(id, itemEl) {
      document.querySelectorAll('.list-item-f').forEach(el => el.classList.remove('active'));
      if(itemEl) itemEl.classList.add('active');

      document.getElementById('emptyStateFnk').classList.add('d-none');
      document.getElementById('editorContent').classList.remove('d-none');
      document.getElementById('editorActions').classList.remove('d-none');
      document.getElementById('editorActions').classList.add('d-flex');
      
      document.getElementById('editFnkTitre').value = "Chargement...";
      
      google.script.run.withSuccessHandler(data => {
          document.getElementById('editFnkId').value = data.id;
          document.getElementById('editFnkRow').value = data.rowIndex;
          document.getElementById('editFnkTitre').value = data.titre;
          
          const mgArea = document.getElementById('editFnkMG');
          const frArea = document.getElementById('editFnkFR');
          mgArea.value = data.contenu_mg;
          frArea.value = data.contenu_fr;
          
          resetFnkDirty();
          setTimeout(() => { autoResize(mgArea); autoResize(frArea); }, 50);
          
      }).getFanekenaDetails(id);
  }

  function createNewFanekena() {
      document.querySelectorAll('.list-item-f').forEach(el => el.classList.remove('active'));
      document.getElementById('emptyStateFnk').classList.add('d-none');
      document.getElementById('editorContent').classList.remove('d-none');
      document.getElementById('editorActions').classList.remove('d-none');
      document.getElementById('editorActions').classList.add('d-flex');
      
      document.getElementById('editFnkId').value = "";
      document.getElementById('editFnkRow').value = "";
      document.getElementById('editFnkTitre').value = "";
      
      const mgArea = document.getElementById('editFnkMG');
      const frArea = document.getElementById('editFnkFR');
      mgArea.value = "";
      frArea.value = "";
      mgArea.style.height = 'auto';
      frArea.style.height = 'auto';
      
      resetFnkDirty();
      document.getElementById('editFnkTitre').focus();
  }

  function saveFanekena() {
      const btn = document.getElementById('btnSaveFnk');
      btn.innerText = "Sauvegarde..."; btn.disabled = true;
      
      const form = {
          rowIndex: document.getElementById('editFnkRow').value,
          titre: document.getElementById('editFnkTitre').value,
          contenu_mg: document.getElementById('editFnkMG').value,
          contenu_fr: document.getElementById('editFnkFR').value
      };
      
      google.script.run.withSuccessHandler(msg => {
          btn.innerText = "Enregistrer"; btn.disabled = false;
          resetFnkDirty();
          loadFanekenaList();
      }).saveFanekenaBackend(form);
  }

  function deleteFanekena() {
      if(!confirm("Supprimer ce texte ?")) return;
      const id = document.getElementById('editFnkId').value;
      if(!id) { createNewFanekena(); return; } 
      
      google.script.run.withSuccessHandler(() => {
          createNewFanekena();
          loadFanekenaList();
          if(window.innerWidth < 768) showFnkMobileList(); // Retour liste auto sur mobile
          else {
              document.getElementById('editorContent').classList.add('d-none');
              document.getElementById('editorActions').classList.remove('d-flex');
              document.getElementById('editorActions').classList.add('d-none');
              document.getElementById('emptyStateFnk').classList.remove('d-none');
          }
          resetFnkDirty();
      }).deleteFanekenaBackend(id);
  }
</script>