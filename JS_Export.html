<script>
/**
 * MODULE EXPORT PDF (Frontend)
 */

let EXPORT_CONTEXT = {
    progId: null,
    pdfLink: null,
    downloadUrl: null,
    isGenerating: false
};

function openExportModal() {
    if (!currentProgData) return;
    
    EXPORT_CONTEXT.progId = currentProgData.id;
    EXPORT_CONTEXT.pdfLink = currentProgData.pdfLink || null;
    EXPORT_CONTEXT.downloadUrl = null;
    EXPORT_CONTEXT.isGenerating = false;
    
    renderExportModalState();
    
    // ON UTILISE LA FONCTION STANDARD (Gère le déplacement dans Body + Centrage CSS)
    if(typeof openCustomModal === 'function') {
        openCustomModal('exportPdfModal', 'progCreatorOverlay');
    } else {
        // Fallback de sécurité si JS_Programme n'est pas chargé
        const m = document.getElementById('exportPdfModal');
        const o = document.getElementById('progCreatorOverlay');
        if(m && m.parentElement !== document.body) document.body.appendChild(m);
        if(o && o.parentElement !== document.body) document.body.appendChild(o);
        if(m) m.style.display = 'flex';
        if(o) o.style.display = 'block';
    }
}

function renderExportModalState() {
    const container = document.getElementById('exportModalContent');
    const hasPdf = !!EXPORT_CONTEXT.pdfLink;
    let html = "";
    
    // ÉTAT : GÉNÉRATION EN COURS (Loader soigné)
    if (EXPORT_CONTEXT.isGenerating) {
        html += `
        <div class="text-center py-5">
            <div class="spinner-border text-danger mb-4" style="width: 3rem; height: 3rem;" role="status"></div>
            <h5 class="fw-bold text-dark">Création du document...</h5>
            <p class="text-muted small px-4">Le système génère le Google Doc et le convertit en PDF. Cela peut prendre quelques secondes.</p>
        </div>`;
    } 
    // ÉTAT : PDF EXISTANT (Interface Premium)
    else if (hasPdf) {
        html += `
        <div class="text-center">
            <div class="pdf-hero-icon"><i class="bi bi-file-earmark-pdf-fill"></i></div>
            <h5 class="fw-bold text-dark mb-1">Votre feuille est prête !</h5>
            <p class="text-muted small mb-4 text-truncate px-4" title="${currentProgData.titre}">${currentProgData.titre}</p>
        </div>

        <div class="pdf-success-card">
            <i class="bi bi-check-circle-fill text-success fs-5"></i>
            <div>Document généré et stocké sur Drive.</div>
        </div>
        
        <!-- ACTION PRINCIPALE -->
        <button class="btn btn-dark w-100 py-2 mb-3 shadow-sm d-flex align-items-center justify-content-center gap-2" onclick="window.open('${EXPORT_CONTEXT.pdfLink}', '_blank')">
            <i class="bi bi-eye-fill"></i> Ouvrir le PDF
        </button>
        
        <!-- ACTIONS SECONDAIRES -->
        <div class="action-grid">
            <button class="btn-action-card" onclick="copyPdfLink()">
                <i class="bi bi-link-45deg"></i>
                <span style="font-size:12px; font-weight:600;">Copier le lien</span>
            </button>
            <button class="btn-action-card" onclick="downloadPdfDirectly()">
                <i class="bi bi-download"></i>
                <span style="font-size:12px; font-weight:600;">Télécharger</span>
            </button>
        </div>
        
        <!-- ZONE DANGER -->
        <div class="danger-zone">
            <button class="btn btn-link text-secondary text-decoration-none btn-sm d-flex align-items-center justify-content-center gap-2 mx-auto" onclick="confirmRegenerate()" style="font-size:11px;">
                <i class="bi bi-arrow-clockwise"></i> Régénérer une nouvelle version
            </button>
        </div>`;
    } 
    // ÉTAT : PAS ENCORE DE PDF (Interface Initiale)
    else {
        html += `
        <div class="text-center mb-4">
            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width:64px; height:64px;">
                <i class="bi bi-magic text-secondary fs-2"></i>
            </div>
            <h5 class="fw-bold m-0 text-dark">Générer la feuille de culte</h5>
            <p class="small text-muted mt-1">Créez un PDF propre basé sur votre modèle Google Doc.</p>
        </div>

        <div class="mb-4">
            <label class="form-check p-3 border rounded bg-white d-flex align-items-center gap-3 cursor-pointer transition-all hover-bg-light">
                <input class="form-check-input mt-0" type="checkbox" id="chkIncludeTrans" checked style="width: 1.2em; height: 1.2em;">
                <div>
                    <div class="fw-bold text-dark" style="font-size:13px;">Inclure les traductions</div>
                    <div class="text-muted" style="font-size:11px;">Ajoute les textes français (italique) sous le malgache.</div>
                </div>
            </label>
        </div>
        
        <div class="d-grid">
            <button class="btn btn-danger py-2 shadow-sm" onclick="triggerGeneration()">
                <span class="fw-bold">Lancer la génération</span>
            </button>
        </div>`;
    }
    
    container.innerHTML = html;
}

function triggerGeneration() {
    const includeTrans = document.getElementById('chkIncludeTrans') ? document.getElementById('chkIncludeTrans').checked : true;
    
    EXPORT_CONTEXT.isGenerating = true;
    renderExportModalState();
    
    google.script.run
        .withSuccessHandler(res => {
            EXPORT_CONTEXT.isGenerating = false;
            
            if (res.success) {
                EXPORT_CONTEXT.pdfLink = res.url;
                EXPORT_CONTEXT.downloadUrl = res.downloadUrl;
                if(currentProgData) currentProgData.pdfLink = res.url;
                renderExportModalState();
                showNotionToast("PDF généré avec succès !", "success");
            } else {
                // ERREUR UX FRIENDLY (Au lieu de alert())
                const container = document.getElementById('exportModalContent');
                container.innerHTML = `
                    <div class="text-center py-3">
                        <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width:50px; height:50px;">
                            <i class="bi bi-x-lg text-danger fs-4"></i>
                        </div>
                        <h6 class="fw-bold text-danger">Erreur de génération</h6>
                        <p class="small text-muted mb-4 px-3">${res.error}</p>
                        <button class="btn btn-outline-dark btn-sm" onclick="renderExportModalState()">Réessayer</button>
                    </div>
                `;
            }
        })
        .withFailureHandler(err => {
            EXPORT_CONTEXT.isGenerating = false;
            // ERREUR SYSTÈME UX FRIENDLY
            const container = document.getElementById('exportModalContent');
            container.innerHTML = `
                <div class="text-center py-3">
                    <div class="bg-danger bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width:50px; height:50px;">
                        <i class="bi bi-bug-fill text-danger fs-4"></i>
                    </div>
                    <h6 class="fw-bold text-danger">Erreur système</h6>
                    <p class="small text-muted mb-4 px-3">${err.message}</p>
                    <button class="btn btn-outline-dark btn-sm" onclick="renderExportModalState()">Réessayer</button>
                </div>
            `;
        })
        .generateProgrammePDF(EXPORT_CONTEXT.progId, includeTrans);
}

function confirmRegenerate() {
    if(confirm("Attention : Cela va écraser la version précédente. Continuer ?")) {
        EXPORT_CONTEXT.pdfLink = null;
        renderExportModalState();
    }
}

function copyPdfLink() {
    if(EXPORT_CONTEXT.pdfLink) {
        navigator.clipboard.writeText(EXPORT_CONTEXT.pdfLink).then(() => {
            showNotionToast("Lien copié !", "success");
        }).catch(err => prompt("Copiez le lien ci-dessous :", EXPORT_CONTEXT.pdfLink));
    }
}

function downloadPdfDirectly() {
    if(EXPORT_CONTEXT.downloadUrl) window.open(EXPORT_CONTEXT.downloadUrl, '_blank');
    else if (EXPORT_CONTEXT.pdfLink) window.open(EXPORT_CONTEXT.pdfLink, '_blank');
}
</script>