<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Global_CSS'); ?>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>

  <div id="app-loader">
    <div class="spinner-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <div style="margin-top: 15px; color: #999; font-size: 12px;">Chargement e-Vavaka...</div>
  </div>

  <div id="headerDock" class="d-none"></div>

  <!-- OVERLAY POUR MENU MOBILE (Ajouté ici) -->
  <div id="mobile-menu-overlay" class="hidden" onclick="toggleSidebar()"></div>

  <div class="mobile-header">
    <i class="bi bi-list" style="font-size: 24px; cursor: pointer; color: var(--text-primary);" onclick="toggleSidebar()"></i>
    <span style="font-weight: 700; color: var(--text-primary);">e-Vavaka</span>
    <div style="width: 24px;"></div>
  </div>

  <div class="app-wrapper">
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-brand"><i class="bi bi-grid-1x2-fill" style="color: var(--primary);"></i><span>e-Vavaka</span></div>
      <div class="nav-link" id="nav-dashboard" onclick="navTo('dashboard')"><i class="bi bi-speedometer2"></i> Tableau de bord</div>
      <div class="nav-link" id="nav-programme" onclick="navTo('programme')"><i class="bi bi-calendar-event"></i> Programme Culte</div>
      <div class="nav-link" id="nav-chants" onclick="navTo('chants')"><i class="bi bi-music-note-list"></i> Chants</div>
      <div class="nav-link" id="nav-fanekena" onclick="navTo('fanekena')"><i class="bi bi-journal-text"></i> Fanekem-pinoana</div>
      <div class="nav-link" id="nav-planning" onclick="navTo('planning')"><i class="bi bi-people"></i> Planning & Équipes</div>
      <div class="nav-link" id="nav-templates" onclick="navTo('templates')"><i class="bi bi-layers"></i> Templates</div>
      <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
        <div class="nav-link" id="nav-config" onclick="navTo('config')" style="cursor: pointer;"><i class="bi bi-gear-fill me-2"></i> Admin / Config</div>
      </div>
    </nav>

    <main class="main-content">
      <div id="view-dashboard" class="view-section"><?!= include('View_Dashboard'); ?></div>
      <div id="view-chants" class="view-section hidden"><?!= include('View_Chants'); ?></div>
      <div id="view-fanekena" class="view-section hidden"><?!= include('View_Fanekena'); ?></div>
      <div id="view-planning" class="view-section hidden"><?!= include('View_Planning'); ?></div>
      <div id="view-templates" class="view-section hidden"><?!= include('View_Templates'); ?></div>
      <div id="view-programme" class="view-section hidden"><?!= include('View_Programme'); ?></div>
      <div id="view-config" class="view-section hidden"><?!= include('View_Config'); ?></div>
    </main>
  </div>

  <?!= include('Global_JS'); ?>
  <?!= include('Component_LiturgyHeader'); ?>
  <?!= include('Shared_BlockRenderer'); ?>
  
  <?!= include('JS_Dashboard'); ?>
  <?!= include('JS_Chants'); ?>
  <?!= include('JS_Fanekena'); ?>
  <?!= include('JS_Programme'); ?>
  <?!= include('JS_Templates'); ?>
  <?!= include('JS_Planning'); ?>
  <?!= include('JS_Config'); ?>

  <script>
    function navTo(viewName, params = {}) {
      // 1. SÉCURITÉ : Dirty Checks
      if (typeof IS_CHANT_DIRTY !== 'undefined' && IS_CHANT_DIRTY) {
          if(!confirm("Modifications en cours. Quitter sans enregistrer ?")) return;
          if(typeof forceClose === 'function') forceClose(); 
          IS_CHANT_DIRTY = false;
      }

      // 2. UI UPDATE
      document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
      const activeLink = document.getElementById('nav-' + viewName);
      if(activeLink) activeLink.classList.add('active');
      
      document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
      const target = document.getElementById('view-' + viewName);
      if(target) target.classList.remove('hidden');
      
      // FERMETURE SIDEBAR + OVERLAY
      if(window.innerWidth < 768) {
          document.getElementById('sidebar').classList.remove('open');
          document.getElementById('mobile-menu-overlay').classList.add('hidden'); // Cache l'overlay
      }

      // 3. HEADER MANAGEMENT
      const sharedHeader = document.getElementById('sharedHeaderRoot');
      const dock = document.getElementById('headerDock');
      if(typeof resetSharedHeader === 'function') resetSharedHeader();
      if(sharedHeader && dock) dock.appendChild(sharedHeader); 
      
      setTimeout(() => {
          if (viewName === 'programme') {
             const place = document.getElementById('programmeHeaderPlaceholder');
             if(place && sharedHeader) place.appendChild(sharedHeader);
             if(typeof restoreProgrammeHeader === 'function') restoreProgrammeHeader();
          } else if (viewName === 'templates') {
             const place = document.getElementById('templateHeaderPlaceholder');
             if(place && sharedHeader) place.appendChild(sharedHeader);
             if(typeof restoreTemplateHeader === 'function') restoreTemplateHeader();
          }
      }, 50);

      // 4. MODULE INIT
      if(viewName === 'dashboard' && typeof initDashboardView === 'function') initDashboardView();
      if(viewName === 'programme') {
          if(Object.keys(params).length === 0 && typeof closeEditor === 'function') closeEditor();
          if(typeof initProgrammeView === 'function') initProgrammeView();
          if (params.id) setTimeout(() => { openEditor(params.id); }, 200);
          else if (params.date) setTimeout(() => { openCreationModal(params.date, '09:30'); }, 200);
      }
      if(viewName === 'chants') {
          if (params.filter && typeof applySpecialFilter === 'function') {
               setTimeout(() => { applySpecialFilter(params); }, 100);
          } else {
              if(typeof initChantsView === 'function') initChantsView();
          }
      }
      if(viewName === 'planning' && typeof initPlanningView === 'function') initPlanningView();
      if(viewName === 'config' && typeof initConfigView === 'function') initConfigView();
      if(viewName === 'fanekena' && typeof initFanekenaView === 'function') initFanekenaView();
    }

    // MISE A JOUR DE TOGGLE SIDEBAR AVEC GESTION OVERLAY
    function toggleSidebar() { 
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-menu-overlay');
        
        sidebar.classList.toggle('open');
        
        if (sidebar.classList.contains('open')) {
            overlay.classList.remove('hidden'); // Affiche l'overlay
        } else {
            overlay.classList.add('hidden'); // Cache l'overlay
        }
    }
    
    window.onload = function() { 
        setTimeout(() => { document.getElementById('app-loader').classList.add('hidden'); }, 800);
        navTo('dashboard');
    }
  </script>
</body>
</html>