<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Global_CSS'); ?>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>

  <div id="app-loader">
    <div class="spinner-dots">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>
    </div>
    <div style="margin-top: 15px; color: #999; font-size: 12px;">Chargement...</div>
  </div>

  <div id="headerDock" class="d-none"></div>

  <div class="mobile-header">
    <i class="bi bi-list" style="font-size: 24px; cursor: pointer;" onclick="toggleSidebar()"></i>
    <span style="font-weight: 600;">Cultes FPMA Toulouse</span>
    <div style="width: 24px;"></div>
  </div>

  <div class="app-wrapper">
    
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <i class="bi bi-grid-1x2-fill" style="color: #2383E2;"></i>
        <span>FPMA Toulouse</span>
      </div>

      <div class="nav-link active" onclick="navTo('chants')">
        <i class="bi bi-music-note-list"></i> Chants
      </div>
      <div class="nav-link" onclick="navTo('fanekena')">
        <i class="bi bi-journal-text"></i> Fanekem-pinoana
      </div>
      <div class="nav-link" onclick="navTo('planning')">
        <i class="bi bi-people"></i> Planning & Équipes
      </div>
      <div class="nav-link" onclick="navTo('templates')">
        <i class="bi bi-layers"></i> Templates
      </div>
      <div class="nav-link" onclick="navTo('programme')">
        <i class="bi bi-calendar-event"></i> Programme Culte
      </div>

      <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color);">
        <div class="nav-link" onclick="navTo('config')" style="cursor: pointer;">
           <i class="bi bi-gear-fill me-2"></i> Admin / Config
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div id="view-chants" class="view-section">
        <?!= include('View_Chants'); ?>
      </div>
      <div id="view-fanekena" class="view-section hidden">
        <?!= include('View_Fanekena'); ?>
      </div>
      <div id="view-planning" class="view-section hidden">
        <?!= include('View_Planning'); ?>
      </div>
      <div id="view-templates" class="view-section hidden">
        <?!= include('View_Templates'); ?>
      </div>
      <div id="view-programme" class="view-section hidden">
        <?!= include('View_Programme'); ?>
      </div>
      <div id="view-config" class="view-section hidden">
        <?!= include('View_Config'); ?>
      </div>
    </main>
  </div>

  <?!= include('Global_JS'); ?>
  <?!= include('Component_LiturgyHeader'); ?>
  <?!= include('Shared_BlockRenderer'); ?>
  
  <?!= include('JS_Chants'); ?>
  <?!= include('JS_Fanekena'); ?>
  <?!= include('JS_Programme'); ?>
  <?!= include('JS_Templates'); ?>
  <?!= include('JS_Planning'); ?>
  <?!= include('JS_Config'); ?>

  <script>
    function navTo(viewName) {
      // 1. DÉTACHEMENT & NETTOYAGE
      const sharedHeader = document.getElementById('sharedHeaderRoot');
      const dock = document.getElementById('headerDock');
      
      if(typeof resetSharedHeader === 'function') resetSharedHeader();

      if(sharedHeader && dock) {
          dock.appendChild(sharedHeader);
      }
      
      // 2. NAVIGATION STANDARD
      document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
      if(event && event.currentTarget) event.currentTarget.classList.add('active');
      
      document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
      const target = document.getElementById('view-' + viewName);
      if(target) target.classList.remove('hidden');
      
      if(window.innerWidth < 768) toggleSidebar();

      // 3. RESTAURATION INTELLIGENTE DU CONTENU
      setTimeout(() => {
          if (viewName === 'programme') {
             const place = document.getElementById('programmeHeaderPlaceholder');
             if(place && sharedHeader) place.appendChild(sharedHeader);
             if(typeof restoreProgrammeHeader === 'function') restoreProgrammeHeader();
             
          } else if (viewName === 'templates') {
             const place = document.getElementById('templateHeaderPlaceholder');
             if(place && sharedHeader) place.appendChild(sharedHeader);
             if(typeof restoreTemplateHeader === 'function') restoreTemplateHeader();
          }
      }, 50);

      // 4. INIT MODULES (Si besoin)
      if(viewName === 'planning' && typeof initPlanningView === 'function') initPlanningView();
      if(viewName === 'config' && typeof initConfigView === 'function') initConfigView();
      if(viewName === 'programme' && typeof initProgrammeView === 'function') initProgrammeView();
      if(viewName === 'fanekena' && typeof initFanekenaView === 'function') initFanekenaView();
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    
    window.onload = function() { 
        setTimeout(() => { document.getElementById('app-loader').classList.add('hidden'); }, 800);
    }
  </script>

</body>
</html>