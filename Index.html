<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Global_CSS'); ?>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>
<body>

  <div id="app-loader">
    <div class="spinner-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    <div style="margin-top: 15px; color: #999; font-size: 12px;">Chargement e-Vavaka...</div>
  </div>

  <div id="headerDock" class="d-none"></div>

  <div id="mobile-menu-overlay" class="hidden" onclick="toggleSidebar()"></div>

  <div class="mobile-header">
    <i class="bi bi-list" style="font-size: 24px; cursor: pointer; color: var(--text-primary);" onclick="toggleSidebar()"></i>
    <span style="font-weight: 700; color: var(--text-primary);">e-Vavaka</span>
    <div style="width: 24px;"></div>
  </div>

  <div class="app-wrapper">
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-brand"><i class="bi bi-grid-1x2-fill" style="color: var(--primary);"></i><span>e-Vavaka</span></div>
      <div class="nav-link" id="nav-dashboard" onclick="navTo('dashboard')"><i class="bi bi-speedometer2"></i> Tableau de bord</div>
      <div class="nav-link" id="nav-programme" onclick="navTo('programme')"><i class="bi bi-calendar-event"></i> Programme Culte</div>
      <div class="nav-link" id="nav-chants" onclick="navTo('chants')"><i class="bi bi-music-note-list"></i> Chants</div>
      <div class="nav-link" id="nav-fanekena" onclick="navTo('fanekena')"><i class="bi bi-journal-text"></i> Fanekem-pinoana</div>
      <div class="nav-link" id="nav-planning" onclick="navTo('planning')"><i class="bi bi-people"></i> Planning & Équipes</div>
      <div class="nav-link" id="nav-templates" onclick="navTo('templates')"><i class="bi bi-layers"></i> Templates</div>
      <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-subtle);">
        <div class="nav-link" id="nav-config" onclick="navTo('config')" style="cursor: pointer;"><i class="bi bi-gear-fill me-2"></i> Admin / Config</div>
      </div>
    </nav>

    <main class="main-content">
      <div id="view-dashboard" class="view-section"><?!= include('View_Dashboard'); ?></div>
      <div id="view-chants" class="view-section hidden"><?!= include('View_Chants'); ?></div>
      <div id="view-fanekena" class="view-section hidden"><?!= include('View_Fanekena'); ?></div>
      <div id="view-planning" class="view-section hidden"><?!= include('View_Planning'); ?></div>
      <div id="view-templates" class="view-section hidden"><?!= include('View_Templates'); ?></div>
      <div id="view-programme" class="view-section hidden"><?!= include('View_Programme'); ?></div>
      <div id="view-config" class="view-section hidden"><?!= include('View_Config'); ?></div>
    </main>
  </div>

  <?!= include('Global_JS'); ?>
  <?!= include('Component_LiturgyHeader'); ?>
  <?!= include('Shared_BlockRenderer'); ?>
  
  <?!= include('JS_Dashboard'); ?>
  <?!= include('JS_Chants'); ?>
  <?!= include('JS_Fanekena'); ?>
  <?!= include('JS_Programme'); ?>
  <?!= include('JS_Templates'); ?>
  <?!= include('JS_Planning'); ?>
  <?!= include('JS_Config'); ?>
  <?!= include('JS_Export'); ?>

<!-- GLOBAL SHARED MODAL: SONG SELECTOR -->
<div id="songSelectorModal" class="notion-dialog-wrapper" style="display:none; width: 950px; max-width: 95vw; height: 85vh;">
    
    <div class="modal-notion-header border-bottom">
        <div class="modal-title-wrap">
            <div class="modal-icon-box"><i class="bi bi-music-note-beamed"></i></div>
            <span class="fw-bold">Sélectionner un chant</span>
        </div>
        <button class="btn-close small" aria-label="Close" onclick="closeAllModals()"></button>
    </div>
    
    <div id="ssContainer" class="ss-container">
        
        <!-- SIDEBAR GAUCHE -->
        <div class="ss-sidebar custom-scrollbar">
            <div class="ss-search-header border-bottom sticky-top">
                <div class="ss-search-input-wrapper">
                    <i class="bi bi-search text-muted me-2"></i>
                    <!-- Input corrigé pour prendre toute la largeur -->
                    <input type="text" id="ssSearchInput" class="ss-search-input" placeholder="Titre, numéro ou paroles..." onkeyup="handleSongSearch(this.value)">
                </div>
                <div class="filter-scroll-container" id="ssFilterContainer"></div>
            </div>
            
            <!-- Liste avec Scroll Forcé -->
            <div class="position-relative flex-grow-1" style="overflow: hidden;">
                <div id="ssResultsList" class="custom-scrollbar">
                    <div class="text-center py-5 text-muted small fst-italic">Tapez une recherche pour commencer...</div>
                </div>
                
                <div id="ssSkeletonList" class="hidden absolute-fill bg-white z-10 w-100 h-100" style="position:absolute; top:0; left:0;">
                    <div class="skeleton-row shimmer"><div class="sk-square"></div><div class="sk-line-long"></div></div>
                    <div class="skeleton-row shimmer"><div class="sk-square"></div><div class="sk-line-short"></div></div>
                    <div class="skeleton-row shimmer"><div class="sk-square"></div><div class="sk-line-long"></div></div>
                    <div class="skeleton-row shimmer"><div class="sk-square"></div><div class="sk-line-short"></div></div>
                    <div class="skeleton-row shimmer"><div class="sk-square"></div><div class="sk-line-long"></div></div>
                    <div class="skeleton-row shimmer"><div class="sk-square"></div><div class="sk-line-short"></div></div>
                </div>
            </div>
        </div>

        <!-- MAIN DROITE -->
        <div class="ss-main">
            
            <!-- Header Mobile -->
            <div class="d-md-none p-3 border-bottom bg-white d-flex align-items-center gap-3">
                <button class="btn btn-sm btn-light border rounded-circle shadow-sm" onclick="toggleSongSelectorView('LIST')"><i class="bi bi-arrow-left"></i></button>
                <div class="fw-bold text-truncate" id="ssMobileTitle">Détails du chant</div>
            </div>

            <!-- Empty State -->
            <div id="ssEmptyState" class="h-100 d-flex flex-column align-items-center justify-content-center text-muted">
                <div class="bg-light rounded-circle p-4 mb-3 border"><i class="bi bi-music-note-list fs-1 opacity-25"></i></div>
                <p class="small fw-medium">Sélectionnez un chant à gauche pour voir les détails</p>
            </div>

            <!-- Vue Détails -->
            <div id="ssDetailsView" class="d-none flex-column h-100">
                <div class="ss-detail-header">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div class="ss-big-title" id="ssDetailTitle">Titre du chant</div>
                            <div class="ss-meta-row">
                                <span class="badge bg-light text-dark border" id="ssDetailRefBadge">...</span>
                                <span id="ssDetailTonalite"></span>
                            </div>
                        </div>
                        
                        <div class="segmented-control">
                            <button class="segment-btn" id="btnSelectAll" onclick="toggleAllStanzas(true)" title="Tout sélectionner">
                                <i class="bi bi-check-all fs-6"></i> Tout
                            </button>
                            <div class="vr opacity-25 my-1"></div>
                            <button class="segment-btn" id="btnDeselectAll" onclick="toggleAllStanzas(false)" title="Tout désélectionner">
                                <i class="bi bi-x fs-6"></i> Rien
                            </button>
                        </div>

                    </div>
                </div>
                
                <!-- Zone de Scroll pour les détails -->
                <div class="ss-scroll-area custom-scrollbar">
                    <div id="ssStanzasList" class="p-4"></div>
                    
                    <div id="ssSkeletonDetails" class="hidden w-100 h-100 bg-white p-4" style="position:absolute; top:0; left:0; z-index:10;">
                        <div class="shimmer sk-line-long mb-4" style="height:30px; width:50%;"></div>
                        <div class="shimmer sk-line-short mb-5" style="height:20px; width:20%;"></div>
                        <div class="shimmer sk-modal-block mb-3" style="height:100px; border:1px solid #eee; border-radius:8px;"></div>
                        <div class="shimmer sk-modal-block mb-3" style="height:100px; border:1px solid #eee; border-radius:8px;"></div>
                    </div>
                </div>

                <div class="p-3 border-top bg-white d-flex justify-content-between align-items-center" style="z-index: 20; flex-shrink: 0;">
                    <span class="small fw-bold text-primary" id="ssSelectionCount">0 sélectionné(s)</span>
                    <button class="btn btn-dark px-4 shadow-sm" id="btnConfirmSelection" disabled onclick="confirmSongSelection()">
                        Insérer le chant
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

  <!-- MODALE SYSTÈME DE NAVIGATION (GLOBAL) -->
  <div id="sysNavModal" class="notion-dialog" style="display:none; width: 320px; padding: 24px; text-align: center; z-index: 20010 !important;">
      <div class="mb-3">
          <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width:50px; height:50px;">
              <i class="bi bi-exclamation-lg text-warning fs-3"></i>
          </div>
          <h6 class="fw-bold m-0 text-dark">Modifications en cours</h6>
          <p class="small text-muted mt-2 mb-0" style="line-height:1.4;">
              Si vous quittez maintenant, vos derniers changements seront perdus.
          </p>
      </div>
      <div class="d-grid gap-2">
          <button class="btn btn-sm btn-danger fw-medium" onclick="confirmSysNav()">Quitter sans sauvegarder</button>
          <button class="btn btn-sm btn-light border text-secondary" onclick="cancelSysNav()">Annuler</button>
      </div>
  </div>
  <div id="sysNavOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:20000 !important; backdrop-filter: blur(2px);"></div>

  <script>
    let pendingNavCallback = null;

    function navTo(viewName, params = {}) {
      const action = () => {
          document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
          const activeLink = document.getElementById('nav-' + viewName);
          if(activeLink) activeLink.classList.add('active');
          
          document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
          const target = document.getElementById('view-' + viewName);
          if(target) target.classList.remove('hidden');
          
          if(window.innerWidth < 768) {
              document.getElementById('sidebar').classList.remove('open');
              document.getElementById('mobile-menu-overlay').classList.add('hidden');
          }

          const sharedHeader = document.getElementById('sharedHeaderRoot');
          const dock = document.getElementById('headerDock');
          if(typeof resetSharedHeader === 'function') resetSharedHeader();
          if(sharedHeader && dock) dock.appendChild(sharedHeader); 
          
          setTimeout(() => {
              if (viewName === 'programme') {
                 const place = document.getElementById('programmeHeaderPlaceholder');
                 if(place && sharedHeader) place.appendChild(sharedHeader);
                 if(typeof restoreProgrammeHeader === 'function') restoreProgrammeHeader();
              } else if (viewName === 'templates') {
                 const place = document.getElementById('templateHeaderPlaceholder');
                 if(place && sharedHeader) place.appendChild(sharedHeader);
                 if(typeof restoreTemplateHeader === 'function') restoreTemplateHeader();
              }
          }, 50);

          if(viewName === 'dashboard' && typeof initDashboardView === 'function') initDashboardView();
          if(viewName === 'programme') {
              if(Object.keys(params).length === 0 && typeof closeEditor === 'function') closeEditor(true);
              if(typeof initProgrammeView === 'function') initProgrammeView();
              if (params.id) setTimeout(() => { openEditor(params.id); }, 200);
              else if (params.date) setTimeout(() => { openCreationModal(params.date, '09:30'); }, 200);
          }
          if(viewName === 'chants') {
              if (params.filter && typeof applySpecialFilter === 'function') {
                   setTimeout(() => { applySpecialFilter(params); }, 100);
              } else {
                  if(typeof initChantsView === 'function') initChantsView();
              }
          }
          if(viewName === 'planning' && typeof initPlanningView === 'function') initPlanningView();
          if(viewName === 'config' && typeof initConfigView === 'function') initConfigView();
          if(viewName === 'fanekena' && typeof initFanekenaView === 'function') initFanekenaView();
      };

      guardNavigation(action);
    }

    function confirmSysNav() {
        document.getElementById('sysNavModal').style.display = 'none';
        document.getElementById('sysNavOverlay').style.display = 'none';
        setDirty(false); 
        if (pendingNavCallback) {
            pendingNavCallback(); 
            pendingNavCallback = null;
        }
    }

    function cancelSysNav() {
        document.getElementById('sysNavModal').style.display = 'none';
        document.getElementById('sysNavOverlay').style.display = 'none';
        pendingNavCallback = null;
    }

    function toggleSidebar() { 
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('mobile-menu-overlay');
        sidebar.classList.toggle('open');
        if (sidebar.classList.contains('open')) overlay.classList.remove('hidden');
        else overlay.classList.add('hidden');
    }
    
    window.onload = function() { 
        setTimeout(() => { document.getElementById('app-loader').classList.add('hidden'); }, 800);
        navTo('dashboard');
    }
  </script>
</body>
</html>