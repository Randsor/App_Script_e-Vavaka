<script>
  // --- VARIABLES GLOBALES ---
  let currentViewDate = new Date();
  let currentProgData = null; 
  let currentMultiEquipes = {};
  let currentSelectedTime = ""; 
  let VALIDATORS_LIST = []; 
  let SECURITY_CONTEXT = "";
  let rolesListConfig = [];
  
  let SONG_SELECTOR_CONTEXT = {
      blockIndex: -1,
      selectedSong: null,
      selectedSequence: [] 
  };
  
  let FANEKENA_CONTEXT = { blockIndex: -1 };
  let activeRecueilFilter = "";

  // --- INITIALISATION ---
  document.addEventListener("DOMContentLoaded", function() {
      closeAllModals();
      
      // Chargement des Widgets Dashboard/Calendrier si présents
      if(document.getElementById('nextCultWidgetContainer')) initNextCultWidget();
      if(document.getElementById('fullCalendarGrid')) renderFullCalendar();
      
      // Chargement de la config
      google.script.run.withSuccessHandler(data => {
          VALIDATORS_LIST = data.valideurs || [];
          rolesListConfig = data.roles || [];
          populateRecueilFilter(); 
      }).getConfigData();
      
      // Déplacement des menus dans le body pour éviter les problèmes de z-index
      ['insertMenu', 'menuOverlay', 'roleMenu'].forEach(id => {
          const el = document.getElementById(id);
          if (el && el.parentElement !== document.body) document.body.appendChild(el);
      });

      // Gestionnaire Clic Outside (Pour fermer les menus)
      const menuOverlay = document.getElementById('menuOverlay');
      if (menuOverlay) {
          menuOverlay.addEventListener('click', closeAllMenus);
      }
  });

  // --- SORTABLE JS (DRAG & DROP MODERN SAAS) ---
  function initSortable() {
      const el = document.getElementById('docBlocksContainer');
      if (el) {
          if(el._sortable) el._sortable.destroy();
          
          el._sortable = new Sortable(el, {
              animation: 300, // Animation fluide (0.3s)
              draggable: '.item-wrapper', // Cible uniquement les items
              handle: '.drag-handle', // La poignée
              ghostClass: 'sortable-ghost', // Style du trou
              chosenClass: 'sortable-chosen', // Style de l'item cliqué
              dragClass: 'sortable-drag', // Style de l'item en vol
              forceFallback: false,
              onStart: function() {
                  document.body.style.cursor = 'grabbing';
              },
              onEnd: function(evt) {
                  document.body.style.cursor = 'default';
                  // Si l'ordre a changé
                  if (evt.oldIndex !== evt.newIndex) {
                    const item = DATA_PROGRAMME_BLOCKS.splice(evt.oldIndex, 1)[0];
                    DATA_PROGRAMME_BLOCKS.splice(evt.newIndex, 0, item);
                    setDirty(true); // ON MARQUE LA MODIFICATION
                    renderCurrentTimeline(); // On redessine pour être propre
                  }
              }
          });
      }
  }

  // --- ACTIONS PROGRAMME (SAUVEGARDE & ÉDITION) ---

  function saveProgramme() {
      const btn = document.querySelector('#toolbarEditMode .btn-dark');
      const originalText = "Enregistrer"; 
      btn.innerText = "..."; 
      btn.disabled = true;
      document.getElementById('saveIndicator').innerText = "Enregistrement...";

      // Récupération des rôles requis (Header)
      const selectedRoles = [];
      document.querySelectorAll('.role-check:checked').forEach(chk => selectedRoles.push(chk.value));

      const form = {
          rowIndex: document.getElementById('progRowIndex').value,
          titre: safeGetValue('commonTitleInput'),
          theme_mg: safeGetValue('docThemeMG'),
          theme_fr: safeGetValue('docThemeFR'),
          contenu: JSON.stringify(DATA_PROGRAMME_BLOCKS),
          settings: JSON.stringify({ 
              subTitle: safeGetValue('commonSubtitleInput'), 
              requiredRoles: selectedRoles 
          })
      };

      // Mise à jour locale immédiate pour éviter le scintillement
      if(currentProgData) {
          currentProgData.titre = form.titre;
          currentProgData.theme_mg = form.theme_mg;
          currentProgData.theme_fr = form.theme_fr;
          if(!currentProgData.settings) currentProgData.settings = {};
          currentProgData.settings.subTitle = safeGetValue('commonSubtitleInput');
          currentProgData.settings.requiredRoles = selectedRoles;
      }

      google.script.run.withSuccessHandler((res) => {
          setDirty(false); // IMPORTANT : On retire le flag dirty
          document.getElementById('saveIndicator').innerText = "Enregistré";
          btn.innerText = originalText; 
          btn.disabled = false;
          
          setTimeout(() => { document.getElementById('saveIndicator').innerText = ""; }, 2000);
          
          if(res.status === 'draft') {
              document.getElementById('editorStatusBadge').className = "status-badge draft";
              document.getElementById('editorStatusBadge').innerText = "Brouillon";
          }
      }).saveProgrammeBackend(form);
  }

  function openEditor(id) { 
      APP_CONTEXT = 'PROGRAMME'; 
      // Bascule d'affichage
      document.getElementById('calendar-view').classList.add('d-none'); 
      document.getElementById('editor-view').classList.remove('d-none'); 
      document.getElementById('editor-view').classList.add('d-flex');
      
      // Loader visuel
      document.getElementById('docBlocksContainer').innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>';

      // Header management
      const sharedHeader = document.getElementById('sharedHeaderRoot'); 
      const placeholder = document.getElementById('programmeHeaderPlaceholder'); 
      if(sharedHeader && placeholder) placeholder.appendChild(sharedHeader);
      if(typeof resetSharedHeader === 'function') resetSharedHeader();

      // Chargement Données
      google.script.run.withSuccessHandler(prog => { 
          currentProgData = prog; 
          currentMultiEquipes = prog.equipes || {}; 
          
          restoreProgrammeHeader();
          
          try { 
              DATA_PROGRAMME_BLOCKS = JSON.parse(prog.contenu); 
          } catch(e) { 
              DATA_PROGRAMME_BLOCKS = []; 
          }
          
          renderCurrentTimeline();
          initSortable(); // Active le Drag & Drop
          
          // Mode Lecture ou Écriture selon validation
          if(prog.status === 'final') setEditorMode('READ_ONLY', prog.validatedBy);
          else setEditorMode('EDIT', null);
          
      }).getProgrammeDetails(id); 
  }

  function closeEditor(force = false) { 
      const action = () => {
          document.getElementById('editor-view').classList.add('d-none');
          document.getElementById('editor-view').classList.remove('d-flex');
          document.getElementById('calendar-view').classList.remove('d-none');
          
          // Rafraîchir le calendrier au retour
          renderFullCalendar();
          initNextCultWidget();
      };

      // Si force=true (vieux hack ou appel système), on ferme direct.
      // Sinon, on passe par le système de garde (Alerte si modif).
      if (force) action(); 
      else guardNavigation(action);
  }

  // --- LOGIQUE CALENDRIER & WIDGETS ---

  function initNextCultWidget() { 
      const container = document.getElementById('nextCultWidgetContainer'); 
      google.script.run.withSuccessHandler(res => { 
          if(!res.found) { 
              container.innerHTML = '<div class="hero-card p-4 text-center text-muted fst-italic w-100">Aucun événement à venir.</div>'; 
              return; 
          } 
          
          // Parsing Date
          const parts = res.date.split('/'); 
          const dObj = new Date(parts[2], parts[1]-1, parts[0]); 
          const dayName = dObj.toLocaleDateString('fr-FR', {weekday:'long'}); 
          const monthName = dObj.toLocaleDateString('fr-FR', {month:'long'}); 
          const dayNum = parts[0]; 
          
          let stripClass = "strip-missing"; 
          let actionBtn = ""; 
          
          if(res.status === 'draft') { 
              stripClass = "strip-draft"; 
              actionBtn = '<button class="btn btn-notion-black shadow-sm" onclick="openEditor(\'' + res.progId + '\')">Editer</button>'; 
          } else if(res.status === 'final') { 
              stripClass = "strip-final"; 
              actionBtn = '<button class="btn btn-notion-outline shadow-sm" onclick="openEditor(\'' + res.progId + '\')">Ouvrir</button>'; 
          } else { 
              let h = (res.horaires && res.horaires.length>0) ? res.horaires[0] : "09:30"; 
              actionBtn = '<button class="btn btn-notion-black shadow-sm" onclick="openCreationModal(\'' + res.date + '\', \'' + h + '\')">Créer</button>'; 
          } 
          
          let hoursHtml = ""; 
          if(res.horaires) res.horaires.forEach(h => hoursHtml += '<span class="time-badge">' + h + '</span>'); 
          
          let themesHtml = ""; 
          if(res.theme_mg || res.theme_fr) { 
              if(res.theme_mg) themesHtml += '<div class="theme-item"><span>MG</span> ' + res.theme_mg + '</div>'; 
              if(res.theme_fr) themesHtml += '<div class="theme-item"><span>FR</span> ' + res.theme_fr + '</div>'; 
          } else { 
              themesHtml = '<div class="text-muted fst-italic small">Thèmes non définis</div>'; 
          } 
          
          container.innerHTML = '<div class="hero-card"><div class="hero-strip ' + stripClass + '"></div><div class="hero-date"><div class="hd-day-name">' + dayName + '</div><div class="hd-day-num">' + dayNum + '</div><div class="hd-month">' + monthName + '</div></div><div class="hero-info"><div class="hero-badges">' + hoursHtml + '</div><div class="hero-title">' + res.titre + '</div><div class="hero-theme">' + themesHtml + '</div></div><div class="hero-action">' + actionBtn + '</div></div>'; 
      }).getNextComingCulte(); 
  }

  function renderFullCalendar() { 
      const year = currentViewDate.getFullYear(); 
      const month = currentViewDate.getMonth(); 
      const monthNames = ["JANVIER", "FÉVRIER", "MARS", "AVRIL", "MAI", "JUIN", "JUILLET", "AOÛT", "SEPTEMBRE", "OCTOBRE", "NOVEMBRE", "DÉCEMBRE"]; 
      
      document.getElementById('calTitle').innerText = monthNames[month] + " " + year; 
      const grid = document.getElementById('fullCalendarGrid'); 
      grid.innerHTML = '<div class="p-5 text-center text-muted w-100" style="grid-column: span 7;"><div class="spinner-border spinner-border-sm"></div></div>'; 
      
      google.script.run.withSuccessHandler(events => { 
          buildGrid(events, month, year); 
      }).getMonthOverview(month, year); 
  }

  function buildGrid(events, month, year) { 
      const grid = document.getElementById('fullCalendarGrid'); 
      grid.innerHTML = ""; 
      
      const daysInMonth = new Date(year, month + 1, 0).getDate(); 
      let firstDay = new Date(year, month, 1).getDay(); 
      let startOffset = (firstDay === 0) ? 6 : firstDay - 1; // Lundi = 0
      
      const now = new Date(); now.setHours(0,0,0,0); 
      
      // Cases vides début de mois
      for(let i=0; i<startOffset; i++) {
          grid.innerHTML += '<div class="cal-cell-wrapper is-empty d-none d-md-flex" style="background:#fcfcfc; cursor:default;"></div>'; 
      }
      
      // Jours du mois
      for(let d=1; d<=daysInMonth; d++) { 
          let dateStr = ('0' + d).slice(-2) + '/' + ('0' + (month+1)).slice(-2) + '/' + year; 
          let entry = events.find(e => e.date === dateStr); 
          let dObj = new Date(year, month, d); 
          
          let wrapperClass = "cal-cell-wrapper"; 
          if(!entry) wrapperClass += " is-empty"; 
          if(dObj.getDay()===0) wrapperClass += " keep-visible"; // Dimanche toujours visible sur mobile
          if(dObj.setHours(0,0,0,0) === now.getTime()) wrapperClass += " today"; 
          if(dObj < now) wrapperClass += " is-past"; 
          
          let clickAction = 'openCreationModal(\'' + year + '-' + ('0' + (month+1)).slice(-2) + '-' + ('0' + d).slice(-2) + '\')'; 
          let content = ""; 
          
          if(entry) { 
              clickAction = entry.progId ? 'openEditor(\'' + entry.progId + '\')' : clickAction; 
              if(entry.status === 'draft') wrapperClass += " bg-draft"; 
              else if(entry.status === 'final') wrapperClass += " bg-final"; 
              else if(entry.status === 'missing') wrapperClass += " bg-missing"; 
              
              let uniqueH = [...new Set(entry.horaires)]; 
              content = '<div class="cal-content"><span class="ev-time">' + uniqueH.join(' / ') + '</span><span class="ev-title">' + entry.titre + '</span></div>'; 
          } 
          
          grid.innerHTML += '<div class="' + wrapperClass + '" onclick="' + clickAction + '"><div class="d-flex flex-column d-md-block align-items-center justify-content-center me-3 me-md-0"><div class="cal-day-num">' + d + '</div></div><div class="w-100">' + content + '</div></div>'; 
      } 
      
      // Cases vides fin de mois (pour compléter la grille)
      let remaining = 7 - ((startOffset + daysInMonth) % 7); 
      if(remaining < 7) {
          for(let k=0; k<remaining; k++) grid.innerHTML += '<div class="cal-cell-wrapper is-empty d-none d-md-flex" style="background:#fcfcfc; cursor:default;"></div>'; 
      }
  }

  function navCalendar(delta) { 
      currentViewDate.setMonth(currentViewDate.getMonth() + delta); 
      renderFullCalendar(); 
  }
  
  function navCalendarToToday() { 
      currentViewDate = new Date(); 
      renderFullCalendar(); 
  }

  // --- HELPERS UI EDITOR (HEADER & TIMELINE) ---

  function restoreProgrammeHeader() { 
      if(!currentProgData) return; 
      document.getElementById('progId').value = currentProgData.id; 
      document.getElementById('progRowIndex').value = currentProgData.rowIndex; 
      document.getElementById('editorDateBadge').innerText = currentProgData.date; 
      
      const [d, m, y] = currentProgData.date.split('/'); 
      const dObj = new Date(y, m-1, d); 
      document.getElementById('headerDateDisplay').innerText = dObj.toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long', year:'numeric'}); 
      
      safeSetValue('commonTitleInput', currentProgData.titre); 
      safeSetValue('commonSubtitleInput', currentProgData.settings?.subTitle || ""); 
      safeSetValue('docThemeMG', currentProgData.theme_mg); 
      safeSetValue('docThemeFR', currentProgData.theme_fr); 
      
      const times = Object.keys(currentMultiEquipes).sort(); 
      if(!currentSelectedTime || !times.includes(currentSelectedTime)) { 
          currentSelectedTime = times.length > 0 ? times[0] : ""; 
      } 
      renderTimeSwitcher(times, currentSelectedTime); 
      switchTeamView(currentSelectedTime); 
  }

  function renderTimeSwitcher(times, activeTime) { 
      const container = document.getElementById('headerTimeSwitcherContainer'); 
      if (!container) return; 
      container.innerHTML = ""; 
      if (times.length <= 1) return; 
      
      times.forEach(t => { 
          const btn = document.createElement('button'); 
          btn.className = 'time-switch-btn ' + (t === activeTime ? 'active' : ''); 
          btn.innerText = t; 
          btn.onclick = (e) => { 
              if(e) { e.preventDefault(); e.stopPropagation(); } 
              switchTeamView(t); 
          }; 
          container.appendChild(btn); 
      }); 
  }

  function switchTeamView(time) { 
      currentSelectedTime = time; 
      document.querySelectorAll('.time-switch-btn').forEach(btn => { 
          btn.classList.toggle('active', btn.innerText === time); 
      }); 
      renderSharedRoles('PROGRAMME', rolesListConfig, currentProgData?.settings?.requiredRoles || [], currentMultiEquipes[time] || {}); 
  }

  function renderCurrentTimeline() { 
      renderSharedBlocks('docBlocksContainer', DATA_PROGRAMME_BLOCKS, 'PROGRAMME'); 
  }

  function setEditorMode(mode, signature) { 
      const container = document.getElementById('editorPaper'); 
      const badge = document.getElementById('editorStatusBadge'); 
      const toolEdit = document.getElementById('toolbarEditMode'); 
      const toolRead = document.getElementById('toolbarReadMode'); 
      const txtSign = document.getElementById('signedByText'); 
      
      if(mode === 'READ_ONLY') { 
          container.classList.add('read-only-mode'); 
          badge.className = "status-badge final"; 
          badge.innerText = "Validé"; 
          toolEdit.className = "d-none"; 
          toolRead.className = "d-flex align-items-center"; 
          txtSign.innerText = "Validé par " + (signature || "Inconnu"); 
      } else { 
          container.classList.remove('read-only-mode'); 
          badge.className = "status-badge draft"; 
          badge.innerText = "Brouillon"; 
          toolEdit.className = "d-flex gap-2"; 
          toolRead.className = "d-none"; 
          txtSign.innerText = ""; 
      } 
  }

  // --- MODALES STANDARD & CREATION ---

  function openCustomModal(modalId, overlayId) {
      const modal = document.getElementById(modalId);
      const overlay = document.getElementById(overlayId);
      if (modal && modal.parentElement !== document.body) {
          document.body.appendChild(modal); 
      }
      if (overlay && overlay.parentElement !== document.body) {
          document.body.appendChild(overlay);
      }
      if(modal) {
          modal.style.display = 'flex'; 
          modal.style.zIndex = '10060';
      }
      if(overlay) {
          overlay.style.display = 'block';
          overlay.style.zIndex = '10055';
      }
      document.body.classList.add('modal-open');
  }

  function closeCustomModal(modalId, overlayId) {
      const modal = document.getElementById(modalId);
      const overlay = document.getElementById(overlayId);
      if(modal) modal.style.display = 'none';
      if(overlay) overlay.style.display = 'none';
      document.body.classList.remove('modal-open');
  }

  function closeAllModals() { 
      // Ajout de 'exportPdfModal' à la liste des modales gérées
      ['creationModal', 'securityModal', 'deleteModal', 'progCreatorOverlay', 'songSelectorModal', 'fanekenaSelectorModal', 'exportPdfModal'].forEach(id => { 
          const el = document.getElementById(id); 
          if(el) el.style.display = 'none'; 
      }); 
      document.body.classList.remove('modal-open');
  }

  function openCreationModal(dateIso, defaultTime) { 
      if(dateIso) { 
          if(dateIso.includes('/')) { 
              let p = dateIso.split('/'); dateIso = `${p[2]}-${p[1]}-${p[0]}`; 
          } 
          document.getElementById('createDateInput').value = dateIso; 
      } 
      document.getElementById('createMethodSelect').value = "blank"; 
      document.getElementById('selectedDuplicateId').value = ""; 
      updateCreationMethodUI(); 
      openCustomModal('creationModal', 'progCreatorOverlay');
  }
  
  function updateCreationMethodUI() { 
      const method = document.getElementById('createMethodSelect').value; 
      document.getElementById('zoneTemplate').classList.add('d-none'); 
      document.getElementById('zoneDuplicate').classList.add('d-none'); 
      document.getElementById('zoneBlank').classList.add('d-none'); 
      
      if(method === 'template') { 
          document.getElementById('zoneTemplate').classList.remove('d-none'); 
          const sel = document.getElementById('templateSelect'); 
          if(sel.options.length === 0) { 
              google.script.run.withSuccessHandler(list => { 
                  sel.innerHTML = ""; 
                  if(list.length === 0) sel.innerHTML = "<option disabled>Aucun modèle trouvé</option>"; 
                  else list.forEach(t => sel.innerHTML += `<option value="${t.id}">${t.titre}</option>`); 
              }).getSelectableTemplates(); 
          } 
      } else if(method === 'duplicate') { 
          document.getElementById('zoneDuplicate').classList.remove('d-none'); 
      } else { 
          document.getElementById('zoneBlank').classList.remove('d-none'); 
      } 
  }

  function searchProgArchives(query) { 
      const container = document.getElementById('duplicateResults'); 
      if(query.length < 2) return; 
      container.innerHTML = `<div class="text-center py-2 text-muted"><div class="spinner-border spinner-border-sm"></div></div>`; 
      google.script.run.withSuccessHandler(results => { 
          container.innerHTML = ""; 
          if(results.length === 0) { 
              container.innerHTML = `<div class="text-center py-2 text-muted small fst-italic">Aucun résultat.</div>`; 
              return; 
          } 
          results.forEach(prog => { 
              const div = document.createElement('div'); 
              div.className = "p-2 border-bottom hover-bg-light cursor-pointer"; 
              div.innerHTML = `<div class="fw-bold small">${prog.date} - ${prog.titre}</div>`; 
              div.onclick = function() { 
                  document.getElementById('selectedDuplicateId').value = prog.id; 
                  Array.from(container.children).forEach(c => c.classList.remove('bg-primary-subtle')); 
                  div.classList.add('bg-primary-subtle'); 
              }; 
              container.appendChild(div); 
          }); 
      }).searchArchivedProgrammes(query); 
  }

  function submitCreationForm() { 
      const dateVal = document.getElementById('createDateInput').value; 
      if(!dateVal) { showNotionToast("Veuillez choisir une date.", "error"); return; } 
      
      const parts = dateVal.split('-'); 
      const dateFR = `${parts[2]}/${parts[1]}/${parts[0]}`; 
      const method = document.getElementById('createMethodSelect').value; 
      let sourceId = null; 
      
      if(method === 'template') { 
          sourceId = document.getElementById('templateSelect').value; 
          if(!sourceId) { showNotionToast("Veuillez choisir un modèle.", "error"); return; } 
      } 
      if(method === 'duplicate') { 
          sourceId = document.getElementById('selectedDuplicateId').value; 
          if(!sourceId) { showNotionToast("Veuillez sélectionner un culte à copier.", "error"); return; } 
      } 
      
      const btn = document.querySelector('#creationModal .btn-dark'); 
      const originalTxt = btn.innerText; 
      btn.innerText = "Création..."; btn.disabled = true; 
      
      const params = { date: dateFR, method: method, sourceId: sourceId }; 
      google.script.run.withSuccessHandler(res => { 
          closeAllModals(); 
          btn.innerText = originalTxt; 
          btn.disabled = false; 
          if(res.success) { 
              openEditor(res.id); 
              renderFullCalendar(); 
              initNextCultWidget(); 
          } else { 
              showNotionToast("Erreur: " + res.message, "error"); 
          } 
      }).createNewProgramme(params); 
  }

  // --- SECURITE & VALIDATION ---

  function askUnlock() { 
      SECURITY_CONTEXT = "UNLOCK"; 
      openSecurityModal("Déverrouiller le programme", "Toute modification repassera le statut en Brouillon.", true); 
  }
  
  function askValidation() { 
      SECURITY_CONTEXT = "VALIDATE"; 
      openSecurityModal("Valider le Programme", "Cette action verrouillera le programme pour diffusion.", false); 
  }
  
  function openSecurityModal(title, subtitle, allowResp) { 
      document.getElementById('secuTitle').innerText = title; 
      document.getElementById('secuSubtitle').innerText = subtitle; 
      const sel = document.getElementById('secuIdentitySelect'); 
      sel.innerHTML = ""; 
      
      if(allowResp) { 
          const opt = document.createElement('option'); opt.value = "EQUIPE"; opt.text = "Responsable / Équipe"; sel.appendChild(opt); 
      } 
      
      VALIDATORS_LIST.forEach(v => { 
          const opt = document.createElement('option'); opt.value = "VALIDEUR|" + v.nom; opt.text = v.nom; sel.appendChild(opt); 
      }); 
      
      document.getElementById('secuCodeInput').value = ""; 
      openCustomModal('securityModal', 'progCreatorOverlay'); 
  }
  
  function submitSecurityAction() { 
      const selVal = document.getElementById('secuIdentitySelect').value; 
      const code = document.getElementById('secuCodeInput').value; 
      const btn = document.getElementById('secuActionBtn'); 
      
      let authType = "EQUIPE"; 
      let authName = ""; 
      if(selVal.startsWith("VALIDEUR|")) { 
          authType = "VALIDEUR"; 
          authName = selVal.split("|")[1]; 
      } 
      
      btn.innerText = "Vérification..."; btn.disabled = true; 
      
      const onSuccess = (res) => { 
          btn.innerText = "Confirmer"; btn.disabled = false; 
          closeAllModals(); 
          if(SECURITY_CONTEXT === "UNLOCK") { 
              setEditorMode('EDIT'); 
              showNotionToast("Programme déverrouillé.", "success"); 
          } else if (SECURITY_CONTEXT === "VALIDATE") { 
              currentProgData.validatedBy = authName + " le " + new Date().toLocaleDateString(); 
              setEditorMode('READ_ONLY', currentProgData.validatedBy); 
              renderFullCalendar(); 
              showNotionToast("Programme validé !", "success"); 
          } 
      }; 
      
      const onFailure = (err) => { 
          btn.innerText = "Confirmer"; btn.disabled = false; 
          const inp = document.getElementById('secuCodeInput'); 
          inp.classList.add('is-invalid'); 
          inp.value = ""; inp.focus(); 
      }; 
      
      if(SECURITY_CONTEXT === "UNLOCK") { 
          google.script.run.withSuccessHandler(isOk => { if(isOk) onSuccess(); else onFailure({message: "Code incorrect"}); }).checkAuthForUnlock(authType, authName, code); 
      } else if (SECURITY_CONTEXT === "VALIDATE") { 
          const progId = document.getElementById('progId').value; 
          google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).validateProgrammeBackend(progId, authName, code); 
      } 
  }
  
  function deleteProgramme() { 
      openCustomModal('deleteModal', 'progCreatorOverlay'); 
  }
  
  function confirmDeleteAction() { 
      const id = document.getElementById('progId').value; 
      const btn = document.querySelector('#deleteModal .btn-danger'); 
      btn.innerText = "..."; btn.disabled = true; 
      
      google.script.run.withSuccessHandler(() => { 
          btn.innerText = "Supprimer"; btn.disabled = false; 
          closeAllModals(); 
          closeEditor(true); 
      }).deleteProgrammeBackend(id); 
  }

  // --- SÉLECTEURS (FANEKENA & CHANT) ---

  // --- SÉLECTEURS (FANEKENA & CHANT) ---

  function openFanekenaSelectorProgramme(index) {
      FANEKENA_CONTEXT.blockIndex = index;
      openCustomModal('fanekenaSelectorModal', 'progCreatorOverlay');
      const container = document.getElementById('fanekenaSelectList');
      container.innerHTML = '<div class="text-center py-4"><div class="spinner-border spinner-border-sm"></div></div>';
      
      google.script.run.withSuccessHandler(list => {
          container.innerHTML = "";
          if(list.length === 0) { container.innerHTML = '<div class="p-3 text-muted small text-center">Aucun texte disponible.</div>'; return; }
          list.forEach(item => {
              const div = document.createElement('div');
              div.className = "song-item"; 
              div.innerHTML = '<div class="fw-bold text-dark" style="font-size:13px;">' + item.titre + '</div><i class="bi bi-chevron-right small text-muted ms-2"></i>';
              div.onclick = function() { selectFanekena(item.id, this); };
              container.appendChild(div);
          });
      }).getFanekenaList();
  }

  function selectFanekena(id, clickedElement) {
      if(clickedElement) {
          clickedElement.innerHTML = '<div class="d-flex align-items-center gap-2 text-primary fw-bold"><div class="spinner-border spinner-border-sm"></div><span>Insertion...</span></div>';
          clickedElement.style.pointerEvents = 'none';
      }
      const idx = FANEKENA_CONTEXT.blockIndex;
      // GESTION CONTEXTE (Template vs Programme)
      const targetData = (APP_CONTEXT === 'TEMPLATE') ? DATA_TEMPLATE_BLOCKS : DATA_PROGRAMME_BLOCKS;
      
      if (idx > -1 && targetData[idx]) {
          google.script.run.withSuccessHandler(data => {
              if(!targetData[idx].data) targetData[idx].data = {};
              targetData[idx].data.id = data.id;
              targetData[idx].data.titre = data.titre;
              targetData[idx].data.contenu_mg = data.contenu_mg;
              targetData[idx].data.contenu_fr = data.contenu_fr;
              setDirty(true); 
              
              if(APP_CONTEXT === 'TEMPLATE') renderSharedBlocks('blocksContainer', targetData, 'TEMPLATE');
              else renderCurrentTimeline();
              
              closeAllModals(); 
              showNotionToast("Confession insérée.", "success");
          }).getFanekenaDetails(id);
      }
  }

  // --- NOUVEAU SÉLECTEUR DE CHANT (MODERN SAAS) ---

  let SS_STATE = { index: -1, song: null, recueilFilter: "ALL", searchTimer: null };

  function openSongSelector(index) {
      SS_STATE.index = index;
      SS_STATE.song = null;
      SS_STATE.recueilFilter = "ALL";
      
      // Reset UI
      document.getElementById('ssSearchInput').value = "";
      document.getElementById('ssResultsList').innerHTML = '<div class="text-center py-5 text-muted small fst-italic">Recherchez un titre ou un numéro...</div>';
      document.getElementById('ssEmptyState').classList.remove('d-none');
      document.getElementById('ssDetailsView').classList.add('d-none');
      document.getElementById('ssDetailsView').classList.remove('d-flex');
      
      toggleSongSelectorView('LIST');
      renderRecueilFilters();
      
      if(typeof openCustomModal === 'function') openCustomModal('songSelectorModal', 'progCreatorOverlay');
      else { 
          // Fallback Template view safety
          document.getElementById('songSelectorModal').style.display='flex';
          document.getElementById('progCreatorOverlay').style.display='block';
      }
      
      setTimeout(() => document.getElementById('ssSearchInput').focus(), 100);
      handleSongSearch("");
  }

  function toggleSongSelectorView(view) {
      const container = document.getElementById('ssContainer');
      if (view === 'DETAILS') container.classList.add('show-details');
      else container.classList.remove('show-details');
  }

  function renderRecueilFilters() {
      const container = document.getElementById('ssFilterContainer');
      container.innerHTML = "";
      
      // "val" est ce qui est envoyé au backend, "label" est ce qui est affiché
      const filters = [
          { val: "ALL", label: "Tout" },
          { val: "Fihirana", label: "Fihirana" },
          { val: "Fihirana Fanampiny", label: "Fihirana Fanampiny" },
          { val: "Antema", label: "Antema" },
          { val: "Tsanta", label: "Tsanta" }
      ];
      
      filters.forEach(f => {
          const pill = document.createElement('div');
          pill.className = `filter-pill ${SS_STATE.recueilFilter === f.val ? 'active' : ''}`;
          pill.innerText = f.label;
          pill.onclick = () => {
              SS_STATE.recueilFilter = f.val;
              renderRecueilFilters();
              handleSongSearch(document.getElementById('ssSearchInput').value);
          };
          container.appendChild(pill);
      });
  }

  function handleSongSearch(query) {
      if(SS_STATE.searchTimer) clearTimeout(SS_STATE.searchTimer);
      
      // Feedback immédiat (Skeleton)
      if (query.length > 0 || SS_STATE.recueilFilter !== 'ALL') {
          document.getElementById('ssResultsList').classList.add('hidden');
          document.getElementById('ssSkeletonList').classList.remove('hidden');
      }

      SS_STATE.searchTimer = setTimeout(() => {
          google.script.run.withSuccessHandler(results => {
              // Switch Vue
              document.getElementById('ssSkeletonList').classList.add('hidden');
              document.getElementById('ssResultsList').classList.remove('hidden');
              
              const container = document.getElementById('ssResultsList');
              container.innerHTML = "";
              
              if(results.length === 0) { 
                  container.innerHTML = '<div class="text-center py-5 text-muted small">Aucun résultat trouvé.</div>'; 
                  return; 
              }
              
              results.forEach(song => {
                  const div = document.createElement('div');
                  div.className = "ss-song-item";
                  if (SS_STATE.song && SS_STATE.song.id === song.id) div.classList.add('active');
                  
                  // --- RÈGLES DE BADGE & NUMÉROTATION ---
                  let recueilClean = (song.recueil || "").toLowerCase().trim();
                  let displayBadge = "";
                  
                  if(recueilClean === 'fihirana') {
                      // Règle a: Fihirana -> 3 digits (001)
                      displayBadge = String(song.numero).padStart(3, '0');
                  } else {
                      // Règles b, c, d : Préfixe + Numéro
                      let prefix = "XX";
                      if(recueilClean.includes('fanampiny')) prefix = "FF";
                      else if(recueilClean.includes('antema')) prefix = "AN";
                      else if(recueilClean.includes('tsanta')) prefix = "TS";
                      
                      displayBadge = `${prefix} ${song.numero}`;
                  }
                  
                  // Construction HTML du Badge
                  // Fihirana en bleu, les autres en gris
                  let badgeClass = (recueilClean === 'fihirana') 
                      ? "bg-primary-subtle text-primary border-primary border-opacity-25" 
                      : "bg-light text-secondary border";
                  
                  let badgeHtml = `<span class="badge ${badgeClass} me-3" style="min-width: 50px; font-size:12px;">${displayBadge}</span>`;
                  
                  // --- GESTION SNIPPET (Paroles) ---
                  let snippetHtml = "";
                  if (song.snippet) {
                      // On affiche l'extrait en petit, italique, grisé
                      snippetHtml = `<div class="text-muted fst-italic mt-1 text-truncate small" style="font-size:11px; opacity:0.8;">${highlightText(song.snippet, query)}</div>`;
                  }

                  div.innerHTML = `
                      <div class="d-flex align-items-center overflow-hidden w-100">
                          ${badgeHtml}
                          <div class="d-flex flex-column overflow-hidden flex-grow-1">
                              <span class="fw-bold text-dark text-truncate" style="font-size:13px;">${highlightText(song.titre, query)}</span>
                              ${snippetHtml}
                          </div>
                      </div>
                      <i class="bi bi-chevron-right small text-muted opacity-25 ms-2"></i>
                  `;
                  
                  div.onclick = () => {
                      document.querySelectorAll('.ss-song-item').forEach(el => el.classList.remove('active'));
                      div.classList.add('active');
                      loadSongDetails(song);
                  };
                  container.appendChild(div);
              });
          }).searchChantsBackend(query, SS_STATE.recueilFilter === 'ALL' ? '' : SS_STATE.recueilFilter);
      }, 300);
  }

  function highlightText(text, query) { 
      if (!query || query.length < 2) return text; 
      const regex = new RegExp('(' + query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi'); 
      return text.replace(regex, '<span class="bg-warning bg-opacity-25">$1</span>'); 
  }

  function loadSongDetails(songStub) {
      toggleSongSelectorView('DETAILS');
      
      document.getElementById('ssEmptyState').classList.add('d-none');
      document.getElementById('ssDetailsView').classList.remove('d-none');
      document.getElementById('ssDetailsView').classList.add('d-flex');
      
      // Squelette
      document.getElementById('ssStanzasList').classList.add('hidden');
      document.getElementById('ssSkeletonDetails').classList.remove('hidden');
      
      // --- 3. FORMATAGE STRICT DU BADGE (Comme demandé) ---
      let recueilClean = (songStub.recueil || "").toLowerCase().trim();
      let displayBadge = "";
      
      if(recueilClean === 'fihirana') {
          // Règle: Fihirana 002
          displayBadge = "Fihirana " + String(songStub.numero).padStart(3, '0');
      } else {
          // Règles: FF 8, AN 2...
          let prefix = "XX";
          if(recueilClean.includes('fanampiny')) prefix = "FF";
          else if(recueilClean.includes('antema')) prefix = "AN";
          else if(recueilClean.includes('tsanta')) prefix = "TS";
          displayBadge = `${prefix} ${songStub.numero}`;
      }

      document.getElementById('ssDetailTitle').innerText = songStub.titre;
      document.getElementById('ssDetailRefBadge').innerText = displayBadge; // Applique le formatage
      document.getElementById('ssMobileTitle').innerText = songStub.titre;
      document.getElementById('ssDetailTonalite').innerText = songStub.tonalite ? `Tonalité : ${songStub.tonalite}` : "";
      
      google.script.run.withSuccessHandler(fullSong => {
          SS_STATE.song = fullSong;
          document.getElementById('ssSkeletonDetails').classList.add('hidden');
          document.getElementById('ssStanzasList').classList.remove('hidden');
          renderStanzasCheckboxes(fullSong);
      }).getChantDetails(songStub.id);
  }

  function renderStanzasCheckboxes(song) {
      const container = document.getElementById('ssStanzasList');
      container.innerHTML = "";
      
      const structureArr = (song.structure || "").split(','); 
      const textMG = (song.paroles_mg || "").split(" /// ");
      let stanzaCount = 1;

      if(structureArr.length === 0 || (structureArr.length === 1 && structureArr[0] === "")) { 
          container.innerHTML = '<div class="text-muted small fst-italic p-3">Aucune structure définie.</div>'; 
          return;
      }

      structureArr.forEach((type, idx) => { 
          const t = type.trim().toUpperCase(); 
          if (t === 'R') return; 
          
          let label = (t === 'C' ? 'Andininy ' + (stanzaCount++) : 'Pont'); 
          
          // --- 2. TEXTE COMPLET (Plus de substring) ---
          // On affiche tout le texte brut
          let fullText = textMG[idx] || "";
          
          let refrainHtml = ""; 
          if (idx + 1 < structureArr.length && structureArr[idx+1].trim().toUpperCase() === 'R') { 
              // Pour le refrain attaché, on garde un extrait pour ne pas surcharger la carte
              // Sauf si tu veux tout le refrain aussi ? Ici je mets un extrait long (100 cars)
              let refContent = (textMG[idx+1] || "");
              refrainHtml = `<div class="mt-2 pt-2 border-top border-secondary border-opacity-10 text-success small fst-italic"><i class="bi bi-arrow-return-right me-1"></i>Ref: ${refContent}</div>`; 
          }

          const card = document.createElement('div');
          card.className = "ss-stanza-card selected";
          card.id = `stz_card_${idx}`;
          card.onclick = () => toggleStanzaSelection(card);
          
          card.innerHTML = `
              <div class="d-flex justify-content-between align-items-start">
                  <div class="w-100 pe-3">
                      <div class="fw-bold text-dark small mb-2">${label}</div>
                      <!-- Classe CSS stanza-text-full pour l'affichage complet -->
                      <div class="stanza-text-full">${fullText}</div>
                      ${refrainHtml}
                  </div>
                  <div class="ss-check-circle flex-shrink-0"><i class="bi bi-check-lg"></i></div>
              </div>
          `;
          container.appendChild(card);
      });
      
      updateSelectionCount();
  }

  function toggleStanzaSelection(card) { card.classList.toggle('selected'); updateSelectionCount(); }
  function toggleAllStanzas(state) { document.querySelectorAll('.ss-stanza-card').forEach(c => { if(state) c.classList.add('selected'); else c.classList.remove('selected'); }); updateSelectionCount(); }

  function updateSelectionCount() {
      const count = document.querySelectorAll('.ss-stanza-card.selected').length;
      document.getElementById('ssSelectionCount').innerText = count + " sélectionné(s)";
      document.getElementById('btnConfirmSelection').disabled = (count === 0);
      const all = document.querySelectorAll('.ss-stanza-card').length;
      if(count === all) { document.getElementById('btnSelectAll').classList.add('d-none'); document.getElementById('btnDeselectAll').classList.remove('d-none'); }
      else { document.getElementById('btnSelectAll').classList.remove('d-none'); document.getElementById('btnDeselectAll').classList.add('d-none'); }
  }

  function confirmSongSelection() {
      const song = SS_STATE.song;
      if(!song) return;
      const cards = document.querySelectorAll('.ss-stanza-card.selected');
      const sequenceIndices = [];
      const sortedCards = Array.from(cards).sort((a, b) => parseInt(a.id.replace('stz_card_', '')) - parseInt(b.id.replace('stz_card_', '')));
      const structArr = (song.structure || "").split(',');
      
      sortedCards.forEach(card => {
          let idx = parseInt(card.id.replace('stz_card_', ''));
          sequenceIndices.push(idx);
          if (idx + 1 < structArr.length && structArr[idx+1].trim().toUpperCase() === 'R') sequenceIndices.push(idx + 1);
      });

      const textMGArr = (song.paroles_mg || "").split(" /// ");
      const textFRArr = (song.paroles_fr || "").split(" /// ");
      let fullTextMG = ""; let fullTextFR = ""; let cleanSequence = []; let cCount = 1; let displayLabels = {}; let totalCouplets = 0;
      
      structArr.forEach((t, i) => { 
          if(t.trim().toUpperCase() === 'C') { displayLabels[i] = cCount++; totalCouplets++; } 
          else if(t.trim().toUpperCase() === 'R') displayLabels[i] = "Ref"; 
          else displayLabels[i] = ""; 
      });

      sequenceIndices.forEach((idx, i) => {
          const txtM = textMGArr[idx] || ""; const txtF = textFRArr[idx] || ""; let label = displayLabels[idx] ? displayLabels[idx] + ". " : "";
          if (i > 0) { fullTextMG += "\n"; fullTextFR += "\n"; } // CORRIGÉ : \n simple
          fullTextMG += label + txtM;
          if(txtF.trim() !== "") fullTextFR += label + txtF;
          if(structArr[idx] && structArr[idx].trim().toUpperCase() === 'C') cleanSequence.push(displayLabels[idx]);
      });

      let summaryStr = (cleanSequence.length === totalCouplets) ? "Tout" : cleanSequence.join(", ");
      const targetData = (APP_CONTEXT === 'TEMPLATE') ? DATA_TEMPLATE_BLOCKS : DATA_PROGRAMME_BLOCKS;
      const idx = SS_STATE.index;

      if(idx > -1 && targetData[idx]) {
          if(!targetData[idx].data) targetData[idx].data = {};
          Object.assign(targetData[idx].data, {
              id: song.id, titre: song.titre, recueil: song.recueil, numero: song.numero,
              sequenceSummary: summaryStr, tonalite: song.tonalite, transStatus: song.transStatus,
              sequence: sequenceIndices, paroles_fixe: fullTextMG, paroles_fr_fixe: fullTextFR, mode: "fixe"
          });
          setDirty(true);
          if(APP_CONTEXT === 'TEMPLATE') renderSharedBlocks('blocksContainer', targetData, 'TEMPLATE');
          else renderCurrentTimeline();
          closeAllModals();
          showNotionToast("Chant inséré !", "success");
      }
  }

  // --- UTILS ---
  function showNotionToast(msg, type) { const container = document.getElementById('notionToastContainer'); if(!container) return; const toast = document.createElement('div'); toast.className = 'notion-toast ' + (type === 'error' ? 'error' : ''); toast.innerHTML = '<i class="bi ' + (type === 'error' ? 'bi-exclamation-circle-fill' : 'bi-check-circle-fill') + '"></i><span>' + msg + '</span>'; container.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(10px)'; setTimeout(() => toast.remove(), 300); }, 3000); }
  function safeSetValue(id, value) { const el = document.getElementById(id); if (el) el.value = value || ""; }
  function safeGetValue(id) { const el = document.getElementById(id); return el ? el.value : ""; }
  function closeAllMenus() { ['insertMenu', 'roleMenu'].forEach(id => { const el = document.getElementById(id); if(el) el.style.display = 'none'; }); const overlay = document.getElementById('menuOverlay'); if (overlay) overlay.style.display = 'none'; }
</script>