<script>
  let searchTimeout = null;
  let loadedRecueils = {}; 

  document.addEventListener("DOMContentLoaded", function() { 
      loadRecueilsFilter(); 
      loadChants();
  });

  // --- 1. GESTION AFFICHAGE ---
  function handleSearchInput() {
    const query = document.getElementById('chantSearchInput').value;
    const searchContainer = document.getElementById('searchResultsContainer');
    const accordionContainer = document.getElementById('accordionContainer');

    if (query.length > 0) {
        accordionContainer.classList.add('hidden');
        searchContainer.classList.remove('hidden');
        document.getElementById('searchSpinner').classList.remove('hidden');
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => { performSearch(query); }, 300);
    } else {
        accordionContainer.classList.remove('hidden');
        searchContainer.classList.add('hidden');
        document.getElementById('searchSpinner').classList.add('hidden');
    }
  }

  function performSearch(query) {
      let historyIds = [];
      try { const stored = localStorage.getItem('chant_history'); if(stored) historyIds = JSON.parse(stored); } catch(e) {}
      
      google.script.run.withSuccessHandler(results => {
          renderList(results, 'searchResultsContainer');
          document.getElementById('searchSpinner').classList.add('hidden');
      }).searchChantsBackend(query, "", historyIds);
  }

  // --- 2. ACCORDÃ‰ON (Code inchangÃ©) ---
  function toggleRecueil(btn, recueilName) {
      const targetId = 'collapse-' + recueilName;
      const targetDiv = document.getElementById(targetId);
      if(!targetDiv) return;

      const isClosed = !targetDiv.classList.contains('show');
      document.querySelectorAll('.accordion-collapse').forEach(el => el.classList.remove('show'));
      document.querySelectorAll('.accordion-button').forEach(el => el.classList.add('collapsed'));

      if(isClosed) {
          targetDiv.classList.add('show');
          btn.classList.remove('collapsed');
          if(!loadedRecueils[recueilName]) {
             google.script.run.withSuccessHandler(results => {
                 loadedRecueils[recueilName] = true; 
                 renderList(results, 'list-' + recueilName);
             }).getChantsByRecueil(recueilName);
          }
      }
  }

  // --- 3. RENDER (Avec Snippet) ---
  function renderList(chants, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    if (chants.length === 0) {
      container.innerHTML = `<div class="p-4 text-center text-muted">Aucun chant trouvÃ©. <br><button class="btn btn-sm btn-outline-primary mt-2" onclick="openChantModal()">Ajouter</button></div>`;
      return;
    }

    chants.forEach(chant => {
      const item = document.createElement('div');
      item.className = "list-group-item list-group-item-action p-3 border-0 border-bottom d-flex justify-content-between align-items-center";
      item.style.cursor = "pointer";
      item.onclick = function() { addToHistory(chant.id); openChantModal(chant.id); };

      let badges = "";
      if (chant.hasMG) badges += `<span class="me-1">ðŸ‡²ðŸ‡¬</span>`;
      if (chant.hasFR) badges += `<span class="me-1">ðŸ‡«ðŸ‡·</span>`;
      
      if (chant.transStatus === 'none') {
          badges += `<span class="badge bg-danger ms-2" style="font-size:0.7em">Non traduit</span>`;
      } else if (chant.transStatus === 'partial') {
          badges += `<span class="badge bg-warning text-dark ms-2" style="font-size:0.7em">Trad. Partielle</span>`;
      }

      let formattedNum = formatSongNumber(chant.recueil, chant.numero);
      
      // AJOUT SNIPPET
      let snippetHtml = "";
      if (chant.snippet) {
          snippetHtml = `<div class="text-truncate fst-italic text-muted" style="font-size: 11px; margin-top: 2px;"><i class="bi bi-text-left me-1"></i>${chant.snippet}</div>`;
      }

      item.innerHTML = `
        <div class="d-flex align-items-center gap-3 w-100">
          <div class="d-flex align-items-center justify-content-center bg-light rounded text-secondary fw-bold small text-center px-1 flex-shrink-0" style="width: 50px; height: 45px;">${formattedNum}</div>
          <div class="flex-grow-1" style="min-width:0;">
             <div class="fw-medium text-dark text-truncate">${chant.titre} ${badges}</div>
             ${snippetHtml}
          </div>
        </div>
        <i class="bi bi-pencil-square text-black-50 small ms-2"></i>
      `;
      container.appendChild(item);
    });
  }

  function formatSongNumber(recueil, numero) {
      if(!numero) return "";
      let n = String(numero);
      if (recueil === "Fihirana") return n.padStart(3, '0');
      if (recueil === "Fihirana Fanampiny") return "FF " + n;
      if (recueil === "Antema") return "AN " + n; 
      return n;
  }

  function addToHistory(id) {
      let historyIds = [];
      try { const stored = localStorage.getItem('chant_history'); if(stored) historyIds = JSON.parse(stored); } catch(e) {}
      historyIds = historyIds.filter(itemId => itemId !== String(id));
      historyIds.unshift(String(id));
      localStorage.setItem('chant_history', JSON.stringify(historyIds.slice(0, 10)));
  }

  // --- 4. Ã‰DITEUR (Code inchangÃ©) ---
  function autoResize(textarea) { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; }
  function openChantModal(id = null) { const modal = new bootstrap.Modal(document.getElementById('modalEditChant')); const container = document.getElementById('editorStrophesContainer'); document.getElementById('editRowIndex').value = ""; document.getElementById('editNumero').value = ""; document.getElementById('editTitre').value = ""; document.getElementById('editTags').value = ""; document.getElementById('editTonalite').value = ""; container.innerHTML = ""; const recueilSelect = document.getElementById('editRecueil'); recueilSelect.innerHTML = ""; const filterSelect = document.getElementById('recueilFilterSelect'); if(filterSelect && filterSelect.options.length > 1) { for(let i=1; i<filterSelect.options.length; i++) { let opt = document.createElement('option'); opt.text = filterSelect.options[i].text; opt.value = filterSelect.options[i].value; recueilSelect.add(opt); } } else { google.script.run.withSuccessHandler(list => { list.forEach(r => { let o = document.createElement('option'); o.text=r; o.value=r; recueilSelect.add(o); }); }).getRecueilsFilterList(); } modal.show(); setTimeout(() => { document.querySelector('#modalEditChant .modal-body').scrollTop = 0; }, 200); if (id) { document.getElementById('modalLoader').classList.remove('hidden'); document.getElementById('modalTitle').innerText = "Modifier"; google.script.run.withSuccessHandler(chant => { document.getElementById('modalLoader').classList.add('hidden'); document.getElementById('editRowIndex').value = chant.rowIndex; document.getElementById('editRecueil').value = chant.recueil; document.getElementById('editNumero').value = chant.numero; document.getElementById('editTitre').value = chant.titre; document.getElementById('editTags').value = chant.tags || ""; if(document.getElementById('editTonalite')) document.getElementById('editTonalite').value = chant.tonalite || ""; const mgParts = chant.paroles_mg ? chant.paroles_mg.split(" /// ") : []; const frParts = chant.paroles_fr ? chant.paroles_fr.split(" /// ") : []; const types = chant.structure ? chant.structure.split(",") : []; for(let i=0; i < mgParts.length; i++) { let type = types[i] || 'C'; addStropheBlock(type, mgParts[i], frParts[i], false); } }).getChantDetails(id); } else { document.getElementById('modalTitle').innerText = "Nouveau chant"; document.getElementById('modalLoader').classList.add('hidden'); document.getElementById('emptyStropheMsg').classList.remove('hidden'); } }
  function addStropheBlock(type, txtMG = "", txtFR = "", scrollToBottom = true) { document.getElementById('emptyStropheMsg').classList.add('hidden'); const container = document.getElementById('editorStrophesContainer'); if (type === 'R' && txtMG === "" && txtFR === "") { const existingRefrains = document.querySelectorAll('.strophe-block[data-type="R"]'); if(existingRefrains.length > 0) { const lastR = existingRefrains[existingRefrains.length - 1]; txtMG = lastR.querySelector('.inp-mg').value; txtFR = lastR.querySelector('.inp-fr').value; showToast("Refrain dupliquÃ© !"); } } const div = document.createElement('div'); const isRefrain = (type === 'R'); div.className = `strophe-block p-3 border rounded mb-2 bg-white`; div.dataset.type = type; div.style.borderLeft = isRefrain ? "3px solid #198754" : "3px solid #0d6efd"; const label = isRefrain ? 'Refrain' : '<span class="counter">#</span>'; div.innerHTML = `<div class="d-flex justify-content-between mb-1"><small class="fw-bold text-uppercase text-secondary" style="font-size:10px; letter-spacing:1px;">${label}</small><i class="bi bi-x-lg text-muted" style="cursor: pointer; font-size:12px;" onclick="this.closest('.strophe-block').remove(); updateStropheNumbers();"></i></div><div class="row g-2"><div class="col-6"><textarea class="form-control form-control-sm border-0 bg-light inp-mg" rows="1" placeholder="Malgache..." oninput="autoResize(this)" style="overflow:hidden; resize:none;">${txtMG}</textarea></div><div class="col-6"><textarea class="form-control form-control-sm border-0 bg-light inp-fr" rows="1" placeholder="FranÃ§ais..." oninput="autoResize(this)" style="overflow:hidden; resize:none;">${txtFR}</textarea></div></div>`; container.appendChild(div); div.querySelectorAll('textarea').forEach(el => autoResize(el)); updateStropheNumbers(); if(scrollToBottom) { setTimeout(() => div.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100); } }
  function updateStropheNumbers() { let counter = 1; document.querySelectorAll('.strophe-block').forEach(block => { if (block.dataset.type === 'C') { const badge = block.querySelector('.counter'); if (badge) badge.innerText = "COUPLET " + counter++; } }); if(document.querySelectorAll('.strophe-block').length === 0) document.getElementById('emptyStropheMsg').classList.remove('hidden'); }
  function showToast(msg) { document.getElementById('toastMessage').innerText = msg; const toastEl = document.getElementById('liveToast'); if(toastEl) { const toast = new bootstrap.Toast(toastEl); toast.show(); } else { alert(msg); } }
  function loadRecueilsFilter() { google.script.run.withSuccessHandler(list => { const sel = document.getElementById('recueilFilterSelect'); if(sel) { sel.innerHTML = '<option value="">Tous les recueils</option>'; list.forEach(r => { let o = document.createElement('option'); o.text=r; o.value=r; sel.add(o); }); } }).getRecueilsFilterList(); }
  function loadChants() {}
  function submitChantSave() { const btn = document.querySelector('#modalEditChant .btn-dark'); const originalText = btn.innerHTML; btn.disabled = true; btn.innerHTML = "Sauvegarde..."; const strophes_mg = []; const strophes_fr = []; const types = []; document.querySelectorAll('.strophe-block').forEach(block => { strophes_mg.push(block.querySelector('.inp-mg').value); strophes_fr.push(block.querySelector('.inp-fr').value); types.push(block.dataset.type); }); const formData = { rowIndex: document.getElementById('editRowIndex').value, recueil: document.getElementById('editRecueil').value, numero: document.getElementById('editNumero').value, titre: document.getElementById('editTitre').value, tonalite: document.getElementById('editTonalite').value, tags: document.getElementById('editTags').value, strophes_mg: strophes_mg, strophes_fr: strophes_fr, types: types }; google.script.run.withSuccessHandler(msg => { bootstrap.Modal.getInstance(document.getElementById('modalEditChant')).hide(); showToast(msg); if(loadedRecueils[formData.recueil]) { loadedRecueils[formData.recueil] = false; const btnRecueil = document.querySelector(`button[onclick*='${formData.recueil}']`); if(btnRecueil) { if(!btnRecueil.classList.contains('collapsed')) { btnRecueil.click(); setTimeout(() => btnRecueil.click(), 300); } else { btnRecueil.click(); } } } btn.disabled = false; btn.innerHTML = originalText; }).saveChantBackend(formData); }
</script>