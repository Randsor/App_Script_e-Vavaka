<script>
// Stockage temporaire des IDs pour le filtrage
let TEMP_DASH_DATA = { missingToneIds: [], missingTransIds: [] };

function initDashboardView() {
const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
const dateStr = new Date().toLocaleDateString('fr-FR', options);
const formattedDate = dateStr.charAt(0).toUpperCase() + dateStr.slice(1);
document.getElementById('dashCurrentDate').innerText = formattedDate;

const loader = document.getElementById('dashboardLoader');
const content = document.getElementById('dashboardContent');
loader.classList.remove('hidden');
content.classList.add('hidden');

google.script.run
.withSuccessHandler(renderDashboard)
.withFailureHandler(err => {
console.error(err);
document.getElementById('dashboardLoader').classList.add('hidden');
})
.getDashboardData();
}

function renderDashboard(data) {
document.getElementById('dashboardLoader').classList.add('hidden');
document.getElementById('dashboardContent').classList.remove('hidden');

animateValue("statTone", 0, data.stats.missingTone, 800);
animateValue("statTrans", 0, data.stats.missingTrans, 800);
animateValue("statDrafts", 0, data.stats.draftProgs, 800);

const hero = document.getElementById('heroContainer');

if (!data.nextCulte) {
hero.innerHTML = `
<div class="hero-wrapper empty-hero">
<div class="mb-3"><i class="bi bi-calendar-x display-4 opacity-25"></i></div>
<div>Aucun culte planifié.</div>
<button class="btn btn-saas-secondary mt-3 mx-auto" onclick="navTo('planning')">Aller au planning</button>
</div>`;
return;
}

const nc = data.nextCulte;

// GAUCHE : INFOS
const parts = nc.date.split('/');
const dObj = new Date(parts[2], parts[1]-1, parts[0]);
const day = parts[0];
const month = dObj.toLocaleDateString('fr-FR', {month:'short'});
const weekday = dObj.toLocaleDateString('fr-FR', {weekday:'long'});

const status = nc.status || "missing";
const statusLabel = status === 'final' ? 'Validé' : (status === 'draft' ? 'Brouillon' : 'Non créé');

let themesHtml = "";
if(nc.theme_mg) themesHtml += `<div class="cult-theme-row"><span class="cult-theme-lang">MG</span>${nc.theme_mg}</div>`;
if(nc.theme_fr) themesHtml += `<div class="cult-theme-row"><span class="cult-theme-lang">FR</span>${nc.theme_fr}</div>`;
if(!themesHtml) themesHtml = `<div class="text-muted small fst-italic">Thèmes non définis</div>`;

// ALERTE CHIPS
let alertHtml = "";
const alerts = nc.songAlerts;

// MISE A JOUR DU STORE TEMPORAIRE
TEMP_DASH_DATA.missingToneIds = alerts ? alerts.missingToneIds : [];
TEMP_DASH_DATA.missingTransIds = alerts ? alerts.missingTransIds : [];

if (alerts && (alerts.missingToneIds.length > 0 || alerts.missingTransIds.length > 0)) {
alertHtml = '<div class="alert-chips-container">';
if (alerts.missingToneIds.length > 0) {
alertHtml += `<div class="alert-chip chip-warning" onclick="goToCorrection('tone')">
<i class="bi bi-music-note-beamed"></i> ${alerts.missingToneIds.length} sans tonalité
</div>`;
}
if (alerts.missingTransIds.length > 0) {
alertHtml += `<div class="alert-chip chip-danger" onclick="goToCorrection('trans')">
<i class="bi bi-translate"></i> ${alerts.missingTransIds.length} traduction(s) mq.
</div>`;
}
alertHtml += '</div>';
}

// DROITE : EQUIPES
let teamHtml = "";
const firstHour = nc.horaires[0];
const groups = (nc.equipes && nc.equipes[firstHour]) ? nc.equipes[firstHour] : {};

const catOrder = ["LITURGIE", "MUSIQUE", "TECHNIQUE", "ACCUEIL", "AUTRE"];
let sortedCats = Object.keys(groups).sort((a,b) => {
let ia = catOrder.indexOf(a.toUpperCase()); let ib = catOrder.indexOf(b.toUpperCase());
if(ia === -1) ia = 99; if(ib === -1) ib = 99;
return ia - ib;
});

if (sortedCats.length > 0) {
teamHtml += '<div class="team-grid">';
sortedCats.forEach(cat => {
let rows = "";
groups[cat].forEach(p => {
rows += `<div class="team-row"><span class="team-role">${p.role}</span><span class="team-name">${p.nom}</span></div>`;
});
teamHtml += `<div class="team-category"><h6>${cat}</h6><div class="team-list">${rows}</div></div>`;
});
teamHtml += '</div>';
} else {
teamHtml = `<div class="text-muted small fst-italic mt-2">Équipe non assignée</div>`;
}

// ACTIONS
let btnAction = "";
if (nc.progId) {
btnAction = `
<button class="btn btn-saas-secondary" onclick="navTo('planning')">Planning</button>
<button class="btn btn-saas-dark" onclick="navTo('programme', {id: '${nc.progId}'})">
<i class="bi bi-pencil-square me-2"></i>Préparer le Culte
</button>`;
} else {
btnAction = `
<button class="btn btn-saas-secondary" onclick="navTo('planning')">Gérer l'équipe</button>
<button class="btn btn-saas-dark" onclick="navTo('programme', {date: '${nc.date}'})">
<i class="bi bi-plus-lg me-2"></i>Créer le Programme
</button>`;
}

hero.innerHTML = `
<div class="hero-wrapper">
<div class="status-strip ${status}"></div>

<div class="hero-content">
<div class="hero-main-info">
<div class="hero-header-row">
<div class="date-badge-large hover-lift">
<div class="dbl-month">${month}</div>
<div class="dbl-day">${day}</div>
<div class="dbl-weekday">${weekday}</div>
</div>
<div>
<div class="d-flex align-items-center mb-1">
<div class="d-flex gap-1">${nc.horaires.map(h => `<span class="badge-saas badge-neutral">${h}</span>`).join('')}</div>
<span class="status-badge-inline ${'st-'+status}">${statusLabel}</span>
</div>
<div class="cult-title">${nc.titre}</div>
</div>
</div>
<div class="cult-themes">${themesHtml}</div>
${alertHtml}
</div>

<div class="hero-team-section">
${teamHtml}
</div>
</div>

<div class="hero-actions">
${btnAction}
</div>
</div>
`;
}

// --- NAVIGATION FILTRE SÉCURISÉE ---
function goToCorrection(type) {
const ids = (type === 'tone') ? TEMP_DASH_DATA.missingToneIds : TEMP_DASH_DATA.missingTransIds;

if (ids && ids.length > 0) {
// On passe bien le tableau brut
navTo('chants', { filter: "specific_ids", ids: ids });
} else {
alert("Erreur : Aucun ID trouvé pour ce filtre.");
}
}

function animateValue(id, start, end, duration) {
if (start === end) { document.getElementById(id).innerText = end; return; }
var range = end - start; var current = start;
var increment = end > start ? 1 : -1;
var stepTime = Math.abs(Math.floor(duration / range));
var obj = document.getElementById(id);
var timer = setInterval(function() {
current += increment; obj.innerHTML = current;
if (current == end) clearInterval(timer);
}, stepTime);
}
</script>